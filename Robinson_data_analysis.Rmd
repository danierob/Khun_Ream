---
title: "Fuel variability across a Cambodian fire season: Data Analysis"
author: "Daniel"
date: "2023-10-09"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

The aim of this research is to explore the heterogeneity of the Dipterocarp mosaic: We conducted **field observations** across the dry season to assess the vertical relationship from soil to canopy, across a range of forest structures (from open to closed) to better understand the variability in surface fuel characteristics between forest types in relation to fire-recruitment function.

**Field Observations**: Canopy cover influences surface fuel in two primary ways: Q1) canopy cover provides a buffer that moderates microclimate, and Q2) canopy cover restricts shade-tolerant species, reducing the surface fuel load while simultaneously adding to the surface fuel load via leaf shedding. As the dry season progresses, microclimate conditions and surface fuel structure change as temperatures reach annual maximums and leaves shed and flush at various intervals according to a diversity of phenologies. Both microclimate and fuel-load are important in establishing the feedbacks that reinforce the mosaic of open-closed canopy states in Cambodia but few empirical records exist that describe the relationship in the region. In this research, we observed canopy cover and surface fuel change across the dry season by asking:

*Q1: 1) How does surface fuel composition and structure vary with canopy cover? 2) How does this relationship change throughout the dry season?*

*Q2: 1) How does surface microclimate vary with canopy cover? 2) How does this relationship change throughout the dry season?*

### Q1: 1) How does the makeup of surface fuel vary with canopy cover? 2) How does this relationship change throughout the dry season?

```{r packages, include=FALSE}
library(tidyverse)
library(readr)
library(ggplot2)
```

#### 1.1) How does the makeup of surface fuel vary with canopy cover?

**1.1.1) The LAI threshold for grass establishment**

Past studies suggest that surface fuel composition varies across a gradient of canopy cover (Hoffman 2012a, Charles-Dominique 2018). This variation is primarily attributed to a transition of surface fuels from grass to litter as canopy cover increases. At a given canopy density, grass growth is restricted to such an extent that it is no longer relevant as a fuel source. In most tropical studies the value of this threshold is \~3.0 LAI (Hoffman 2012a, Cardosa 2018) but no study, to my knowledge, has quantified this relationship, between canopy cover and grass biomass in Southeast Asia.

In this analysis, we consider the relationship between LAI and grass load at peak biomass (early in the dry season). We will join the LAI observation 1+2 data with the Biomass observation 1 data to assess the relationship. We use observations 1 (Jan. 26) and 2 (Feb. 2) of the LAI data because LAI did not start to decline significantly until LAI ob. 3 (Feb. 8), so averaging obs. 1 and 2 will mitigate deviations in LAI records due to sky conditions at the time of observation without sacrificing data integrity.

```{r 1.1.1 setup, message=FALSE, warning=FALSE, include=TRUE}
#loading in LAI data
LAI <- read_csv("C:/Users/d/Desktop/UBC 2023/Robinson-Project-MSc/KH_data/LAI/LAI_V1.csv", 
    col_types = cols(date = col_date(format = "%m/%d/%Y"), 
        LAI = col_number()))
View(LAI)

#isolating and averaging LAI ob 1&2  data across all observations for one value per quadrant (n=50)
LAI_1 <- LAI %>%
  group_by(plot_id, quad_id) %>%
  filter(obs_period == "1" | obs_period == "2") %>% 
  summarise(mean_LAI = mean(LAI))

#loading in biomass_V2 data
biomass <- read_csv("C:/Users/d/Desktop/UBC 2023/Robinson-Project-MSc/KH_data/Biomass/biomass_V2.csv", 
     col_types = cols(grass_height = col_number(), litter_depth = col_number(), grass_per = col_number(), wood_per = col_number(), bare_per = col_number(),  litter_per = col_number(), mass_grass = col_number(), mass_liana = col_number(), mass_wood = col_number(), mass_litter = col_number(), seedlings = col_number(), grass_vol = col_number(), grass_bulk = col_number(), litter_vol = col_number(), litter_bulk = col_number(), fine_vol = col_number(), fine_bulk = col_number()))

#isolating ob1 (early) biomass
biomass_1 <- biomass %>%
  group_by(plot_id, quad_id) %>% 
  filter(season == "early") %>% 
  summarise(grass_mass = mean(mass_grass), litter_mass = mean(mass_litter), wood_mass = mean(mass_wood), woody_mass = mean(mass_liana + seedlings*10), grass_height = mean(grass_height), litter_depth = mean(litter_depth))

#merging LAI_1 and biomass_1 into LAIxbiomass_1
LAIxbiomass_1 <- left_join(LAI_1, biomass_1, by = c("plot_id", "quad_id"))

#drop the quadrants that did not have biomass records
LAIxbiomass_1 <- LAIxbiomass_1 %>% drop_na(grass_mass)

```

```{r 1.1.1 plot, message=FALSE, warning=FALSE}
#PLOT IT OUT
ggplot(LAIxbiomass_1, aes(mean_LAI, grass_mass)) +
  geom_point(alpha = .2) + stat_smooth(fill= NA, colour="brown")+
  ylim(0,250)
```

**1.1.1 Analysis:**

Fitting a line for grass biomass across the canopy gradient will require an asymptotic regression.

```{r 1.1.1 analysis}

```

**1.1.2: Litter distribution across the canopy gradient**

### Q3: a) How does probability of fire vary with canopy cover? b) How does this change across the dry season?

#### a) How does probability of fire vary with canopy cover?

To compare modeled fire likelihood across canopy cover, I will average the 8 LAI observations over the course of the season for each quadrant (for n = 46 LAI means total). I believe this method, rather than using Basal Area or any single given LAI measurement provides the best representation of the changing canopy cover conditions at any fixed point during the fire season. Averaging LAI values for each quadrant across the season will also mitigate deviations in LAI records due to sky conditions at the time of observation (LAI-2200c is sensitive to slight variation in sensor positioning or angle and to sky conditions, which is partially accounted for with the K-records and scattering corrections, but still prone to deviation).

```{r LAI}
#loading in LAI data
LAI <- read_csv("C:/Users/d/Desktop/UBC 2023/Robinson-Project-MSc/KH_data/LAI/LAI_V1.csv", 
    col_types = cols(date = col_date(format = "%m/%d/%Y"), 
        LAI = col_number()))
View(LAI)

#averaging LAI data across all observations for one value per quadrant (n=50)
LAI_avg <- LAI %>%
  group_by(plot_id, quad_id) %>%
  summarise(mean_LAI = mean(LAI, na.rm = TRUE))

```

For each quadrant (n = 46) we will average the fuel moisture contents from the 8 observations throughout the season. I believe this method of averaging all observations rather than using any single fuel moisture observation will provide the best representation of fuel moisture for a given quadrant across the season and will mitigate the effects of deviations in fuel moisture sampling time. Dead fuel moisture content is very sensitive to diurnal fluctuations in microclimate, and maximum daily fuel curing lags behind the sun's rising each day. By averaging fuel moisture across the season, we will reduce the variation attributed to differences in fuel moisture collection time (all measurement were taken after 10:00 am to account for this to some degree, but variation still exists). For BehavePlus input we will use fuel moisture from several fuel categories: live woody, live herbaceous, 100 hour, 10 hour, and 1 hour fuel (for 1 hr we will include litter fuel moistures which are structurally similar to 1 hr sticks).

```{r fuel_moisture pivot_wider}
fm <- read_csv("C:/Users/d/Desktop/UBC 2023/Robinson-Project-MSc/KH_data/Fuel-Moisture/fm_V3.csv", 
    col_types = cols(date = col_date(format = "%d/%m/%Y"), 
        fuel_moisture = col_number()))
View(fm)

#remove the species column as it gets in the way of pivot_wider:
fm <- fm %>% 
  select(-c(species))

#and now to untidy the fuel_types, so that each is its own column, displaying the fuel moisture data
fm <- fm %>% 
pivot_wider(names_from = fuel_type,
            values_from = fuel_moisture)

#a few of the quadrants had data from multiple grass species (for comparing bamboo vs C4 grass in the same location) that were displayed as a vector after pivoting wider, I will average these data.
fm$grass <- lapply(fm$grass, function(x) mean(x))

#replacing null with NA
fm$woody_leaf[is.na(fm$woody_leaf)] <- "NA"


#converting the columns back to numeric from list, 4 of the columns must be converted to character first and then numeric because they had NULL values. I believe the NULL values came from the pivot_wider operation and appeared for the placeholder data that never had an entry across all observations.

fm$grass <- as.numeric(unlist(fm$grass))
fm$woody_leaf <- as.numeric(unlist(as.character(fm$woody_leaf)))
fm$litter <- as.numeric(unlist(as.character(fm$litter)))
fm$one_hr <- as.numeric(unlist(as.character(fm$one_hr)))
fm$ten_hr <- as.numeric(unlist(as.character(fm$ten_hr)))
fm$hundred_hr <- as.numeric(unlist(as.character(fm$hundred_hr)))

#making sure everything converted properly:
head(fm)

#One more thing, change quad_id: qc to c to match other tables.
fm <- fm %>%
  mutate(quad_id = case_when(quad_id == "qc" ~ "c", TRUE ~ quad_id))

write.csv(fm, "C:/Users/d/Desktop/UBC 2023/Robinson-Project-MSc/KH_data/Fuel-Moisture/fm_V4.csv", row.names=FALSE)
```

```{r fuel_mositure}
fm <- read_csv("C:/Users/d/Desktop/UBC 2023/Robinson-Project-MSc/KH_data/Fuel-Moisture/fm_V4.csv", 
    col_types = cols(date = col_date(format = "%Y-%m-%d"), grass = col_number(), woody_leaf = col_number(),litter = col_number(), hundred_hr = col_number(), ten_hr = col_number(), one_hr = col_number()))

#Averaging fm for each fuel class across season for behaveplus input
fm_avg <- fm %>% 
 group_by(plot_id, quad_id) %>%
  summarise(woody_leaf = mean(woody_leaf, na.rm = TRUE), grass = mean(grass, na.rm = TRUE), litter = mean(litter, na.rm = TRUE), ten_hr = mean(ten_hr, na.rm = TRUE), hundred_hr = mean(hundred_hr, na.rm = TRUE))
```

For comparing fire likelihood across canopy cover, the two biomass observations (early and late season) will also be averaged for each quadrant. Each logger will then serve as the point at which input (response) variables (biomass, fuel moisture, microclimate) and canopy cover (explanatory) variable will be determined for 46 individual sets of models run. We will end up with a scatterplot of 46 fire behavior outputs which we will then use to create a mixed-effects model in R. Quadrants within the same plot will be spatially autocorrelated, so analysis will include random effects for plot type. I anticipate a sigmoidal relationship between canopy cover and fire likelihood, where fire likelihood is relatively similar at canopy covers where grass is unobstructed (0-3 LAI), but experiences a steep decline at the point at which grass growth is restricted (\~3 LAI), and then leveling out again at relatively low fire behavior throughout the closed canopy (from 3-6 LAI).

```{r biomass}
#load in biomass_V2 data
biomass <- read_csv("C:/Users/d/Desktop/UBC 2023/Robinson-Project-MSc/KH_data/Biomass/biomass_V2.csv", 
     col_types = cols(grass_height = col_number(), litter_depth = col_number(), grass_per = col_number(), wood_per = col_number(), bare_per = col_number(),  litter_per = col_number(), mass_grass = col_number(), mass_liana = col_number(), mass_wood = col_number(), mass_litter = col_number(), seedlings = col_number(), grass_vol = col_number(), grass_bulk = col_number(), litter_vol = col_number(), litter_bulk = col_number(), fine_vol = col_number(), fine_bulk = col_number()))

#there were two biomass observation periods in early and late season and each quadrant consisted of 3 records for a total of n=150 records for each season and n=300 records in total
#we will average across season and quadrants for n=50 records (4 of which are NA because no data for the missing sensors)

biomass_avg <- biomass %>%
  group_by(plot_id, quad_id) %>%
  summarise(grass_mass = mean(mass_grass), litter_mass = mean(mass_litter), wood_mass = mean(mass_wood), woody_mass = mean(mass_liana + seedlings*10), grass_height = mean(grass_height), litter_depth = mean(litter_depth))

#the biomass input in the model requires mass per unit area so we will determine kg/m^2 for each fuel type. The quadrat was .25m^2.

biomass_load <- biomass_avg %>% 
  group_by(plot_id) %>% 
  mutate_at(vars(3:6), ~ . * .004)
 
```

Additionally, we will average

Lastly, we will populate the input for surface area to volume ratio (SA:V) and moisture of extinction for each plot by identifying which of the 40 standard fuel models (Scott and Burgan 2005) best fit our field observations.

```{r fuel models}
#we will find the average fuel load and fuel depth per plot and convert to tonnes/acre (1 to 10) to help gauge which of Scott and Burgan's 40 models is the best fuel model to pair each plot with.

biomass_load %>%
  group_by(plot_id) %>%
  summarise(across(everything(), mean, na.rm = TRUE)) %>% 
  mutate_at(vars(3:6), ~ . * 10)

```

#### The plots are aligned with these models:

-   TL6/186 - Moderate load, less compact. Spread rate moderate; flame length low. PRIMARY CARRIER OF THE FIRE IS DEAD AND DOWN WOODY FUEL (LITTER) BENEATH A FOREST CANOPY: **DDF2, EVG1, EVG2, EVG3, EVG4, EVG5**

-   TU3/163 - Fuel bed is moderate litter load with grass and shrub components. Humid climate. Spread rate high; flame length moderate. PRIMARY CARRIER OF THE FIRE IS GRASS OR SHRUBS MIXED WITH LITTER FROM FOREST CANOPY (TIMBER-UNDERSTORY): **DDF3**

-   GR5/105 - Dense, coarse grass, average depth about 1 to 2 feet (0.3 to 0.6 meters). Spread rate very high; flame length high. Subhumid to humid climate (rainfall adequate in all seasons). Extinction moisture content is 30 to 40 percent. Spread rate high; flame length moderate.PRIMARY CARRIER GRASS: **DDF4, DDF5, DDF6**

#### Pluggin values into Behaveplus:

There's probably a faster way to do this, some R package or another, but I'm going to plug all 46 inputs into the Behaveplus software, and then create a new table by hand for the outputs:

**Breakdown of input values (SURFACE fire spread model and Probability of Ignition (PIG) model):**

-   Fuel Model Number

-   Fuel Model Code

-   1-hr fuel load (kg/m2): Input from litter load

-   10-hr fuel load (kg/m2): Input from half of wood load

-   100-hr fuel load (kg/m2): Input from half of wood load

-   Live Herbaceous Fuel Load (kg/m2): Input from grass load

-   Live Woody Fuel Load (kg/m2): Input from woody load

-   1-h, Live Herbaceous, and Live Woody SA/V (m2/m3): Input from model constants for each plot (see above step)

-   Fuel Bed Depth (m): Input from grass height when grass is relatively continuous enough to sustain fire (\>0.1kg/m2), otherwise determined from litter depth

-   Dead fuel moisture of extinction (%): Similar to SA/V, auto-populated by fuel code

-   Dead Fuel and Live Fuel Heat Content (kJ/kg): Held constant = 18622

-   Fuel Moisture (%): All fuel moisture input come from fuel moisture averages described above

-   Midflame Windspeed

-   Slope Steepness (%): Held constant at 0, very little slope involved in area

-   Temperature (C):

-   Fuel Shading From Sun:
