---
title: "Fuel variability across a Cambodian fire season: Preliminary Data Analysis"
author: "Daniel"
date: "2023-10-09"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

## Introduction

The aim of this research is to explore the heterogeneity of fire recruitment function in the Dipterocarp mosaic: We conducted field observations across the dry season to assess the horizontal distribution of fuel structure and microclimate across a range of canopy cover, from open to closed, to better understand how Cambodia's mosaic is shaped by fire.

This Chapter will be divided into two parts: **Part 1: field observations** and **Part 2: fire modelling**.

**Part 1** will focus on describing the variability in fuel distribution and fuel microclimate across a canopy gradient and across the dry season. We will explore how the surface conditions of open and closed canopy states differ and how this relationship changes in the presence of prolonged seasonal drought. We will discuss our study system in the context of alternate stable states, and compare the mosaic dynamics of our system with that of mosaics in other studies throughout the tropics. We will direct our focus by approaching these questions:

*Q1: 1) How does surface fuel composition and structure vary with canopy cover? 2) How does this relationship change throughout the dry season?*

*Q2: 1) How does surface microclimate vary with canopy cover? 2) How does this relationship change throughout the dry season?*

**Part 2** utilizes fire modelling to better understand the variable role of fire recruitment across the mosaic. Understanding fire likelihood and severity is complicated by interacting factors and nonlinear relationships among the various determinants of fire. In an effort to provide some additional clarity and to tease out the shifting relationships between composition and fuel moisture and microclimate across the dry season, we will be using the fire model Behaveplus6 to evaluate predicted fire effects in the absence of physical fire data by asking:

*Q3: 1) How does probability of fire vary with canopy cover? 2) How does this change across the dry season?*

*Q4: 1) Is fire likelihood more limited by fuel or microclimate? 2) Does this relative relationship change throughout the dry season?*

## Analysis

```{r packages, include=FALSE}
library(mgcv)
library(tidyverse)
library(readr)
library(ggplot2)
library(lme4)
library(nlme)
library(ggeffects)
library(vtable)
library(DHARMa)
```

## Part 1: Defining the mosaic throughout the dry season: An assessment of fuel availability across a canopy gradient

Canopy cover influences surface fuel in two primary ways: Q1) canopy cover restricts shade-intolerant species, like C4 grasses, reducing the surface fuel load while simultaneously/contrastingly adding to the surface fuel load via leaf shedding, and Q2) canopy cover provides a buffer that moderates microclimate by decreasing daily highs in temp and daily lows in RH (and less significantly by buffering nighttime temp lows and RH highs). As the dry season progresses, microclimate conditions and surface fuel structure change as temperatures reach annual maximums and leaves shed and flush at various intervals according to a diversity of phenologies. Both microclimate and fuel-load are important in establishing the feedbacks that reinforce the mosaic of open-closed canopy states in Cambodia but few empirical records exist (particlaurly when compared to similar mosaicked ecosystems in Australia, Africa, and South America) that describe the relationship in the region. We will explore how the multiple variables associated with these two drivers of fuel availability - fuel structure and fuel microclimate - vary in relation to canopy cover and across a dry season.

## Q1: 1) How does the distribution of surface fuel vary with canopy cover? 2) How does this relationship change throughout the dry season?

The amount and type of surface fuel is critical to the distribution of forest savanna mosaics (ref). Savannas can be difficult to delineate given the wide range of physiognomies in tree cover that they support, so we define savannas here as an area with continuous grassy understory and a significant tree component (Lehmann et al 2011, Ratnam 2011). This definition is intentionally unconcerned with an upper margin of canopy cover or tree cover or stand height or stand structure because to set a rigid boundary (say anything below 60% tree cover is savanna, and anything above is forest) is to ignore the variability in functional traits and site specific conditions of both the woody and herbaceous communities that exist throughout the savanna range. Instead, this definition relies on the ubiquitous relationship between canopy shading and grass exclusion, where at a certain amount of canopy cover, grass is no longer able to grow densely enough to support fire. This is particularly true for the highly flammable C4 grasses, which generally have a lower capacity for establishment in low-light environments (ref).

### 1.1) How does the distribution of surface fuel vary with canopy cover?

#### 1.1.1) The LAI threshold for grass establishment

Past studies suggest that surface fuel composition varies across a gradient of canopy cover, however the precise canopy cover/tree density thresholds for grass exclusion varies by system (Hoffman 2012a, Charles-Dominique 2018). Surface fuels transition from grass to litter as canopy cover increases. Research in forest-savanna mosaics often emphasize the sharpness of the boundaries between open and closed canopy ecosystems. At a given canopy density, grass growth is restricted to such an extent that it is no longer relevant as a fuel source (fire-threshold). In most tropical studies the value of this threshold is \~3.0 LAI (Hoffman 2012a, Cardosa 2018) but no study, to my knowledge, has quantified this relationship, between canopy cover and grass biomass in Southeast Asia (Khaing 2019 looked at the C4 layer and herb layer relationship with BAsal Area).

In this analysis, we consider the relationship between LAI and grass load at peak biomass (early in the dry season). We will join the LAI observation 1+2 data with the Biomass observation 1 data to assess the relationship. We use observations 1 (Jan. 26) and 2 (Feb. 2) of the LAI data because LAI did not start to decline significantly until LAI ob. 3 (Feb. 8), so averaging obs. 1 and 2 will mitigate deviations in LAI records due to sky conditions at the time of observation without sacrificing data integrity.

```{r 1.1.1 setup, include=FALSE}
#loading in LAI data
LAI <- read_csv("C:/Users/d/Desktop/UBC 2023/Robinson-Project-MSc/KH_data/LAI/LAI_V1.csv", 
    col_types = cols(date = col_date(format = "%m/%d/%Y"), 
        LAI = col_number()))

LAI_early <- LAI %>%
  group_by(plot_id, quad_id, plot_type, season) %>%
  filter(obs_period == "1" | obs_period == "2") %>% 
  summarise(mean_LAI = mean(LAI))


#make season a factor
LAI$season <- factor(LAI$season)

#make plot_id a factor
LAI$plot_id <- factor(LAI$plot_id)

#isolating and averaging LAI ob 1&2  data across all observations for one value per quadrant (n=50)
LAI_early <- LAI %>%
  group_by(plot_id, quad_id, plot_type, season) %>%
  filter(obs_period == "1" | obs_period == "2") %>% 
  summarise(mean_LAI = mean(LAI))


#loading in biomass_V4 data
biomass <- read_csv("C:/Users/d/Desktop/UBC 2023/Robinson-Project-MSc/KH_data/Biomass/biomass_V4.csv", 
    col_types = cols(grass_height = col_number(), 
        litter_depth = col_number(), grass_per = col_number(), 
        wood_per = col_number(), bare_per = col_number(), 
        litter_per = col_number(), grass_mass = col_number(), 
        other_mass = col_number(), wood_mass = col_number(), 
        litter_mass = col_number(), seedlings = col_integer()))

#make season a factor
biomass$season <- factor(biomass$season)

#make plot_id a factor
biomass$plot_id <- factor(biomass$plot_id)

#multiply fuel masses by 4 to get g/m2 (quads were .25m l and w)
biomass <- biomass %>%
  mutate(grass_mass = grass_mass*4, litter_mass = litter_mass*4, wood_mass = wood_mass*4, other_mass = other_mass *4)


#isolating ob1 (early) biomass
biomass_early <- biomass %>%
  group_by(plot_id, quad_id) %>% 
  filter(season == "early") %>% 
  summarise(grass_mass = mean(grass_mass), litter_mass = mean(litter_mass), wood_mass = mean(wood_mass), other_mass = mean(other_mass + seedlings*10), grass_height = mean(grass_height), litter_depth = mean(litter_depth))

#merging LAI_1 and biomass_1 into LAIxbiomass_1
LAIxbiomass_early <- left_join(LAI_early, biomass_early, by = c("plot_id", "quad_id"))

#drop the quadrants that did not have biomass records
LAIxbiomass_early <- LAIxbiomass_early %>% drop_na(grass_mass)

```

**1.1.1 Plot**

```{r 1.1.1 stat_smooth 3rd order polynomial plot, message=FALSE, warning=FALSE}
# 3rd order polynomial
# PLOT IT OUT
ggplot(LAIxbiomass_early, aes(x = mean_LAI, y = grass_mass)) +
  geom_point(alpha = .5) + stat_smooth(fill = NA, colour="brown")+
   labs(title = "Grass Load Decreases Across Canopy Cover") + ylab("Grass Load (g)")+ xlab("LAI")+
  ylim(0,250)+
  theme_minimal()

```

**1.1.1 Analysis:**

Fitting a line for grass biomass across the canopy gradient will require polynomial regression.

```{r 1.1.1 model}
model <- lme(grass_mass ~ poly(mean_LAI, degree = 3), random = ~ 1 | plot_id, data = LAIxbiomass_early)

summary(model)

```

```{r 1.1.1 3rd order polynomial model plot, include = FALSE}
#This plot is fit with the model predictions but aesthetically is not as good as the plot fit with stat_smooth, so for now this plot will be include = FALSE.

pred <- ggpredict(model, terms = "mean_LAI")

(ggplot(pred) + 
   geom_smooth(aes(x = x, y = predicted), fill = NA, color = "red") +          # slope
   geom_ribbon(aes(x = x, ymin = predicted - std.error, ymax = predicted + std.error), 
               fill = NA, alpha = 0.5) +  # error band
   geom_point(data = LAIxbiomass_early,                # adding the raw data
              aes(x = LAIxbiomass_early$mean_LAI, y = LAIxbiomass_early$grass_mass)) + 
  ylim(0, 230)+
   labs(x = "LAI", y = "Grass Mass (g)", 
        title = "Grass Load Decreases Across Canopy Gradient") + 
   theme_bw()
)


```

#### 1.1.2) Litter distribution across the canopy gradient

Grass burns readily due to its fine, aerated structure and continuity. As a result, grass is the major fuel type that delineates differences in fire recruitment between open and closed ecosystems. But litter, dead wood, and live woody fuels can also be important components to the fuel load depending on the fuel amount and arrangement. In savanna-forest systems, leaf litter tends to increase as tree density increases (Hoffman 2012b, Newberry 2020), and when grass is excluded, litter is the primary source of ignition and the primary fuel carrier. I expect litter to increase across the tree density gradient in our system, as in similar studies. However, it is important to note that the savannas in Cambodia are considered particularly mesic, or more densely treed, than the savannas of similar study systems on other continents (ref), which may result in more litter in the savanna. While in the closed forest, even the most densely canopied tree stands of our research area have a high degree of deciduousness, which may result in more litter in the closed forest. Ultimately the litter loads will likely vary with tree density depending on species composition and time of season as a reflection of complex phenological diversity of this forest mosaic.

For this analysis we will use the same LAI observation periods (ob. 1 and ob. 2) as in 1.1.1, but we will look at litter mass across the dry season - across both biomass observations - to consider the variable phenology of the landscape.

```{r 1.1.2 setup, include = FALSE}
#loading in LAI data
LAI <- read_csv("C:/Users/d/Desktop/UBC 2023/Robinson-Project-MSc/KH_data/LAI/LAI_V1.csv", 
    col_types = cols(date = col_date(format = "%m/%d/%Y"), 
        LAI = col_number()))

#isolating and averaging LAI ob 1&2  data across all observations for one value per quadrant (n=50)
LAI_early <- LAI %>%
  group_by(plot_id, quad_id) %>%
  filter(obs_period == "1" | obs_period == "2") %>% 
  summarise(mean_LAI = mean(LAI))

biomass <- read_csv("C:/Users/d/Desktop/UBC 2023/Robinson-Project-MSc/KH_data/Biomass/biomass_V2.csv", 
     col_types = cols(grass_height = col_number(), litter_depth = col_number(), grass_per = col_number(), wood_per = col_number(), bare_per = col_number(),  litter_per = col_number(), mass_grass = col_number(), mass_liana = col_number(), mass_wood = col_number(), mass_litter = col_number(), seedlings = col_number(), grass_vol = col_number(), grass_bulk = col_number(), litter_vol = col_number(), litter_bulk = col_number(), fine_vol = col_number(), fine_bulk = col_number()))

#averaging biomass obs 1 and 2
biomass_avg <- biomass %>%
  group_by(plot_id, quad_id) %>%
  summarise(grass_mass = mean(mass_grass), litter_mass = mean(mass_litter), wood_mass = mean(mass_wood), woody_mass = mean(mass_liana + seedlings*10), grass_height = mean(grass_height), litter_depth = mean(litter_depth))

#merging LAI_1 and biomass_avg into LAIxbiomass_2
LAI_earlyxbiomass_avg <- left_join(LAI_early, biomass_avg, by = c("plot_id", "quad_id"))

#drop the quadrants that did not have biomass records
LAI_earlyxbiomass_avg <- LAI_earlyxbiomass_avg %>% drop_na(grass_mass)

```

**1.1.2 Analysis**

We will look at a simple linear regression and a mixed effects model to see if plot_type needs to be nested.

**Simple Linear Model:** Assumptions are tested in markdown, but not included in knitted document.

```{r 1.1.2 SLR model, include = FALSE}

#IDK
hist(LAI_earlyxbiomass_avg$mean_LAI)

#Simple Linear Regression Analysis of litter mass explained by LAI
model <- lm(litter_mass ~ mean_LAI, data = LAI_earlyxbiomass_avg)

#residuals look fine
plot(lm, which = 1)
#QQ not great
plot(lm, which = 2)
#Independent?
(colour_plot <- ggplot(LAI_earlyxbiomass_avg, aes(x = mean_LAI, y = litter_mass, colour = plot_id)) +
    geom_point(size = 2) +
    theme_classic() +
    theme(legend.position = "none"))
```

```{r 1.1.2 SLR summary}
summary(model)
```

**Mixed Effects Model:** Assumptions tested in markdown code, not included here. Mixed effects assumptions tests look better, as does summary statistics.

```{r 1.1.2 mixed effects model, include = FALSE}
#Not independent because of plot_type, so...

#Mixed Effects Analysis with random intercepts for plot_type
mixed.model <- lmer(litter_mass ~ mean_LAI + (1|plot_id), data = LAI_earlyxbiomass_avg)

#check out assumptions again
#residuals
plot(mixed.model)

#QQ looking better than SLR
qqnorm(resid(mixed.model))
qqline(resid(mixed.model))
```

Interpreting the Mixed Effects Output:

```{r 1.1.2 mixed effects output, echo=FALSE}
summary(mixed.model)
```

**Fixed Effects:** We can see from the 1.1.2 output that when we control for the grouping effect of plot_id (which are spatially autocorrelated) we still have a significant relationship between LAI and litter_mass as indicated by the mean_LAI Estimate in the output which is much larger than the Std. Error.

**Random Effects:** Controlling for plot_id through random intercepts was a good call, as 250.9/(250.6+551.4) = ~32% of the variation is explained by plot_id.

**1.1.2 Plot:**

```{r 1.1.2 Plot}

# Extract the prediction data frame
pred <- ggpredict(mixed.model, terms = c("mean_LAI"))  # this gives overall predictions for the model

# Plot the predictions 

(ggplot(pred) + 
   geom_line(aes(x = x, y = predicted), color = "red") +          # slope
   geom_ribbon(aes(x = x, ymin = predicted - std.error, ymax = predicted + std.error), 
               fill = NA, alpha = 0.5) +  # error band
   geom_point(data = LAI_earlyxbiomass_avg,                # adding the raw data
              aes(x = LAI_earlyxbiomass_avg$mean_LAI, y = LAI_earlyxbiomass_avg$litter_mass)) + 
   labs(x = "LAI", y = "Litter Mass (g)", 
        title = "Litter Increases Across Canopy Gradient") + 
   theme_bw()
)
```

#### 1.1.3) Fine fuel bulk density across the canopy gradient

Dry grass and dry leaf litter are the main components of fine dead fuel. However, in the field, grass and litter tend to have contrasting flammability. This contrast is largely due to variation in fuel arrangement, specifically bulk density (g/cm3). The compact arrangement -- high bulk density -- of litter reduces fire likelihood and spread compared to the light, aerated architecture -- low bulk density -- of grass. Curing grasses invite a passing fuel source to ignite and carry fire more readily. In savanna-forest mosaics of other continents, bulk density has been identified as the primary driver in establishing the functional dichotomy between forest and savanna (Hoffman 2012b, Newberry 2020). I anticipate fine fuel bulk densities to increase as grass biomass decreases and litter biomass increases. I predict peak bulk densities will correspond to peak canopy cover, where litter accumulation should be greatest and grass presence should be lowest.

In this analysis, we consider the relationship between LAI and fine fuel bulk density at peak biomass, only considering biomass ob. 1 (as in 1.1.1), to evaluate the maximum extent of fine fuel load discrepancy.

```{r 1.1.3 setup, include = FALSE}
#see 1.1.1 to bring in dataframes: LAIxbiomass_1
```

```{r 1.1.3 testing assumptions, include=FALSE}
#Not independent because of plot_type, so we will do mixed effects rather than simple linear regression

#Mixed Effects Analysis with random intercepts for plot_type
mixed.model <- lmer(fine_bulk ~ mean_LAI + (1|plot_id), data = LAIxbiomass_early)

ggplot(LAIxbiomass_early, aes(mean_LAI, fine_bulk))+
  geom_point() + stat_smooth(method = "lm")

#check out assumptions 
#residuals exhibit quite a bit of heteroscadeiscity 
plot(mixed.model)

```

Fine_bulk vs LAI was not passing the variance assumption so we will transform the data (square root looks sufficient):

```{r 1.1.3 sqrt tranformed analysis, include=FALSE}
#Mixed Effects Analysis with random intercepts for plot_type
mixed.model <- lmer(sqrt(fine_bulk) ~ mean_LAI + (1|plot_id), data = LAIxbiomass_early)

#test assumptions
#variance of residuals looking much better
plot(mixed.model)

#QQ looking good
qqnorm(resid(mixed.model))
qqline(resid(mixed.model))

```

**Interpreting the Mixed Effects Output:**

```{r 1.1.3 model output}

#load mixed.lmer from code chunk above
summary(mixed.lmer2)
```

**Fixed Effects:** We can see from the 1.1.3 output that when we control for the grouping effect of plot_id (which are spatially autocorrelated) we still have a significant relationship between LAI and fine bulk density as indicated by the mean_LAI Estimate in the output which is larger than the Std. Error.

**Random Effects:** Controlling for plot_id through random intercepts was a good call, as .0578/(.0578+.0271) = \~68% of the variation is explained by plot_id.

**1.1.3 Plot:**

```{r 1.1.3 plot}
# Extract the prediction data frame
pred <- ggpredict(mixed.model, terms = c("mean_LAI"))  # this gives overall predictions for the model

# Plot the predictions 

(ggplot(pred) + 
   geom_line(aes(x = x, y = predicted), color = "red") +          # slope
   geom_ribbon(aes(x = x, ymin = predicted - std.error, ymax = predicted + std.error), 
               fill = NA, alpha = 0.5) +  # error band
   geom_point(data = LAIxbiomass_early,                # adding the raw data
              aes(x = LAIxbiomass_early$mean_LAI, y = sqrt(LAIxbiomass_$fine_bulk))) + 
   labs(x = "LAI", y = "SQRT Fine Fuel Bulk Density", 
        title = "Fine Fuel (Grass + Litter) Bulk Density Increases Across Canopy Gradient") + 
   theme_bw()
)
```

### 1.2) How does the relationship between surface fuel distribution and canopy cover change over the dry season?

As canopy density transitions from opened to closed, fuel composition shifts away from being grass dominated and toward being litter dominated. Over the course of a dry season the distinction between open and closed surface fuel loads [decreases]{.underline} as grasses senescence and all deciduous and most evergreen trees (to a lesser magnitude) drop their leaves (Williams 2008), adding to the litter component of the surface fuel composition. The timing of senescence is highly variable among species in seasonal tropical forests, but over the season the result is the ultimately the same: As the dry season progresses, more fuel is added to the surface in the form of litter, packing surface fuels more densely.

This analysis will expand on the idea from analysis 1.1.1, where we looked at fuel load across the canopy gradient, but we will add a factor to the model to evaluate how vegetation load/structure changes from early to late in the dry season.

#### 1.2.1) Polynomial: Canopy - grass relationships from the early to late dry season

Grasses are at their peak biomass and peak fuel moisture in the early part of the dry season (ref... and observations from the field). As the dry season extends, grasses cure and desiccate which decreases overall grass biomass and compacts grass structure in the savanna.

For 1.2.1 analysis I am going to create a 3rd order polynomial model that has an interaction between season (a two-level categorical variable) and LAI (a continuous numerical variable) to test if there is significant difference across the two seasonal levels (early and late) in the relationship between canopy cover (LAI) and grass. First (a), we will restrict canopy cover to LAI observations 1+2 as in 1.1, representing static spatial positions, so each LAI will have two corresponding grass records, one late and one early season. Then (b), we will write a model that temporally pairs biomass and LAI obs, so early season grass will be paired with early season LAI obs and late season grass will be paired with late season LAI obs.

**1.2.1a)**

```{r 1.2.1a setup, include = FALSE}
#see 1.1.1 to bring in LAI data, creation of LAI_1 and biomass data. This will all look very similar to 1.1.1, the only exception being that biomass will include early and late season observations. Where as in 1.1.1 we only looked at early season obs. 

#loading in LAI data
LAI <- read_csv("C:/Users/d/Desktop/UBC 2023/Robinson-Project-MSc/KH_data/LAI/LAI_V1.csv", 
    col_types = cols(date = col_date(format = "%m/%d/%Y"), 
        LAI = col_number()))

#make season a factor
LAI$season <- factor(LAI$season)

#make plot_id a factor
LAI$plot_id <- factor(LAI$plot_id)

biomass <- read_csv("C:/Users/d/Desktop/UBC 2023/Robinson-Project-MSc/KH_data/Biomass/biomass_V4.csv", 
    col_types = cols(grass_height = col_number(), 
        litter_depth = col_number(), grass_per = col_number(), 
        wood_per = col_number(), bare_per = col_number(), 
        litter_per = col_number(), grass_mass = col_number(), 
        other_mass = col_number(), wood_mass = col_number(), 
        litter_mass = col_number(), seedlings = col_integer()))

#make season a factor
biomass$season <- factor(biomass$season)

#make plot_id a factor
biomass$plot_id <- factor(biomass$plot_id)


#we again must average the 3 biomass obs taken at each logger for one observation per logger per seasonal period for a total of 100 (50 x 2) minus 8 equals 92 records.
biomass_seasons <- biomass %>%
  group_by(plot_id, quad_id, season) %>% 
  summarise(grass_mass = mean(grass_mass*4), litter_mass = mean(litter_mass*4), wood_mass = mean(wood_mass*4), other_mass = mean(other_mass*4), grass_height = mean(grass_height), litter_depth = mean(litter_depth), grass_per = mean(grass_per), litter_per = mean(litter_per))

#isolating and averaging LAI ob 1&2  data across all observations for one value per quadrant (n=50)

LAI_early <- LAI %>%
  group_by(plot_id, quad_id) %>%
  filter(obs_period == "1" | obs_period == "2") %>% 
  summarise(mean_LAI = mean(LAI))

#merging LAI_early and biomass_seasons into LAIxbiomass_seasons
LAI_earlyxbiomass_seasons <- right_join(LAI_early, biomass_seasons, by = c("plot_id", "quad_id"))

#drop the quadrants that did not have biomass records
LAI_earlyxbiomass_seasons <- LAI_earlyxbiomass_seasons %>% drop_na(grass_mass)
```

```{r 1.2.1a model}

model <- lm(grass_mass ~ poly(mean_LAI, 3)*season, LAI_earlyxbiomass_seasons)
summary(model)

```


The "seasonlate" line and "poly(mean_LAI, 3)3:seasonlate" line of the output are the parts we are most interested in for comparing how the early and late season relationship between canopy cover and grass mass differs. "poly(mean_LAI, 3)3:seasonlate" has a low t-value indicating very little difference between polynomial term and seasonal term interaction, time of season does not seem to affect the way grass is distributed, the lines fit for early and late season follow almost identical trends. However, looking at "seasonlate" indicates some significance (.037) in difference in early and late season intercepts. Altogether, there is slightly less grass in the late season but it follows the same declining polynomial trend across the canopy gradient as the early season.

Seasonality alone does not seem to play a very important role as far as grass *distribution* is concerned over the canopy gradient., as evidenced by the plot. Note that in the plot, there will be two grass mass records for each LAI observation, since we only consider early season LAI in this analysis. Both early and late season biomass data for a given logger are considered under the same canopy cover, thus the model resulting from this method best represent changes in surface biomass under a seasonally changing canopy cover. This concept has been difficult for me to wrap my head around, but essentially, **by making the canopy cover static across response variable observations, we create a model that is honest about how seasonal change is happening at the surface fuel level, but not as honest about the more general relationship between canopy cover and surface fuel. Plot 1.2.1a shows how grass load at 46 particular locations is lower in the late season than the early season.**

```{r 1.2.1a plot}
ggplot(LAI_earlyxbiomass_seasons, aes(x = mean_LAI, y = grass_mass*4, color = season)) +
  geom_point() +
  geom_smooth(method = "lm", formula = y ~ poly(x, 3), se = FALSE) +
  labs(title = "Late Season Grass",
       x = "Early Season LAI", y = "Grass Load (g/m2)", color = "season") +
  ylim(0, 1000) +
  geom_hline(yintercept = 180.4, linetype = "dashed")+
  theme_minimal()
```
The dotted line in the plot indicated the "threshold" grass density of ~2 tonnes/ha at which point grass connectivity is typicall sufficient to carry fire indicated by Cardoso 2022. Bear in mind that there is no consideration of litter. 

**1.2.1b)** Now, we will write a model that temporally pairs biomass and LAI obs, so early season grass will be paired with early season LAI obs and late season grass will be paired with late season LAI obs. Where method 1.2.1a was useful for looking at surface fuel change, this method will concentrate on the relationship between canopy cover and grass mass, as both canopy cover and grass mass change across the season.

```{r 1.2.1b setup, include = FALSE}
#we have the early season LAI in LAI_early, now we need to add late season LAI (LAI_late) to create LAI_early_late. We do this rather than using the complete LAI data, as we need 50 + 50 LAI obs that are most representative of LAI at time of collection to pair with the 50 + 50 biomass obs.

LAI_early <- LAI %>%
  group_by(plot_id, quad_id, plot_type, season) %>%
  filter(obs_period == "1" | obs_period == "2") %>% 
  summarise(mean_LAI = mean(LAI))

#to make LAI late, I'm going to do the same thing as LAI_early but with obs 7 & 8, which were the closest LAI obs to the late biomass obs.
LAI_late <- LAI %>%
  group_by(plot_id, quad_id, plot_type, season) %>%
  filter(obs_period == "7" | obs_period == "8") %>% 
  summarise(mean_LAI = mean(LAI, na.rm = TRUE))

#now to stack these LAI dfs on top of each other
LAI_seasons <- bind_rows(LAI_early, LAI_late)

#merging LAI_early and biomass_1 into LAIxbiomass_2
LAIxbiomass_seasons <- right_join(LAI_seasons, biomass_seasons, by = c("plot_id", "quad_id", "season"))

#drop the quadrants that did not have biomass records
LAIxbiomass_seasons <- LAIxbiomass_seasons %>% drop_na(grass_mass)
```

Now that the LAIxbiomass_early_late table is sorted, we run the same modelling steps as above in 1.2.1a.

```{r 1.2.1b model}

model <- lm(grass_mass ~ poly(mean_LAI, 3)*season, LAIxbiomass_seasons)
summary(model)

```

```{r 1.2.1b plot}
ggplot(LAIxbiomass_seasons, aes(x = mean_LAI, y = grass_mass*4, color = season)) +
  geom_point() +
  geom_smooth(method = "lm", formula = y ~ poly(x, 3), se = FALSE) +
  labs(title = "Grassy Component of Fuel Makeup is Lower in Late Dry Season",
       x = "LAI", y = "Grass Load (g/m2)", color = "season") +
  ylim(0, 900) +
  theme_minimal()        

ggplot(LAIxbiomass_seasons, aes(x = mean_LAI, y = grass_mass*4, color = season)) +
  geom_point() +
  geom_smooth(fill = "NA") +
  labs(title = "Grassy Component of Surface Fuel is Lower in Late Dry Season",
       x = "LAI", y = "Grass Load (g/m2)", color = "season") +
  ylim(0, 900) +
  theme_minimal()   
```

In this plot, the early season regression line is identical to 1.2.1a, but the late season regression has shifted to the left, exaggerating the difference in intercept and coefficient between early and late season. Note how grass load reaches 0 at around 3 LAI in 1.2.1a and grass load reaches 0 at 2 LAI in 1.2.1b. By pairing late season grass loads with late season LAI we get a better idea of the relationship between changing canopy cover and changing grass load, both of which are decreasing throughout the season.


#### 1.2.1) GAM: Canopy - grass relationships from the early to late dry season
NOW I WILL TRY PLOTTING GRASS AND LAI WITH A Generalized Additive Models

First we will inspect different GAM models using fixed LAI values from the early season, in part 1.2.1b we will use the best gam from part one to look at the same relationship but with an early and a late season LAI.

```{r 1.2.1a setup, include = FALSE}

#loading in LAI data
LAI <- read_csv("C:/Users/d/Desktop/UBC 2023/Robinson-Project-MSc/KH_data/LAI/LAI_V1.csv", 
    col_types = cols(date = col_date(format = "%m/%d/%Y"), 
        LAI = col_number()))

LAI$season <- factor(LAI$season)

#make plot_id a factor
LAI$plot_id <- factor(LAI$plot_id)

#loading in biomass_V4 data
biomass <- read_csv("C:/Users/d/Desktop/UBC 2023/Robinson-Project-MSc/KH_data/Biomass/biomass_V4.csv", 
    col_types = cols(grass_height = col_number(), 
        litter_depth = col_number(), grass_per = col_number(), 
        wood_per = col_number(), bare_per = col_number(), 
        litter_per = col_number(), grass_mass = col_number(), 
        other_mass = col_number(), wood_mass = col_number(), 
        litter_mass = col_number(), seedlings = col_integer()))

#make season a factor
biomass$season <- factor(biomass$season)

#make plot_id a factor
biomass$plot_id <- factor(biomass$plot_id)

#multiply fuel masses by 4 to get g/m2 (quads were .25m l and w)
biomass <- biomass %>%
  mutate(grass_mass = grass_mass*4, litter_mass = litter_mass*4, wood_mass = wood_mass*4, other_mass = other_mass *4)

#we again must average the 3 biomass obs taken at each logger for one observation per logger per seasonal period for a total of 100 (50 x 2) minus 8 equals 92 records.
#multiplying everything by 4 because the quads were.25m wide so to get g/m2
biomass_seasons <- biomass %>%
  group_by(plot_id, quad_id, season) %>% 
  summarise(grass_mass = mean(grass_mass), litter_mass = mean(litter_mass), wood_mass = mean(wood_mass), other_mass = mean(other_mass), grass_height = mean(grass_height), litter_depth = mean(litter_depth), grass_per = mean(grass_per), litter_per = mean(litter_per))

#isolating and averaging LAI ob 1&2  data across all observations for one value per quadrant (n=50)

LAI_early <- LAI %>%
  group_by(plot_id, quad_id) %>%
  filter(obs_period == "1" | obs_period == "2") %>% 
  summarise(mean_LAI = mean(LAI))

#merging LAI_early and biomass_seasons into LAIxbiomass_seasons
LAI_earlyxbiomass_seasons <- right_join(LAI_early, biomass_seasons, by = c("plot_id", "quad_id"))

#drop the quadrants that did not have biomass records
LAI_earlyxbiomass_seasons <- LAI_earlyxbiomass_seasons %>% drop_na(grass_mass)

```

**1.2.1a) Fixed LAI**
```{r 1.2.1a GAM}
gam_model <- gam(grass_mass ~ season + s(mean_LAI, by = season), 
           data = LAI_earlyxbiomass_seasons, method = "REML")

summary(gam_model)
k.check(gam_model)
gam.check(gam_model)
```

```{r 1.2.1a GAM_tweedie}
#Trying a different distribution

gam_model_tw <- gam(grass_mass ~ season + s(mean_LAI, by = season), family = tw(link = "log"),
           data = LAI_earlyxbiomass_seasons, method = "REML")
                    
  
summary(gam_model_tw)
k.check(gam_model_tw)
gam.check(gam_model_tw)

#They look much better with a tweedie dist
```

```{r 1.2.1a GAMM_tweedie}
## Now try adding a random effect for plot_id

# Creating a GAM model with a random intercept for 'plot_id'
gamm_model_tw <- gam(grass_mass ~ season + s(mean_LAI, by = season) + s(plot_id, bs = "re"), family = tw(link = "log"), data = LAI_earlyxbiomass_seasons, method = "REML")
                    
summary(gamm_model_tw)
k.check(gamm_model_tw)
gam.check(gamm_model_tw)


#Comparing the GAM and the GAMM
AIC(gam_model_tw, gamm_model_tw)
```

I'm unsure how to plot the GAMM at the moment! Adding the random factor results in a plot with loads of lines. 
```{r 1.2.1a GAM plot}

#remove huge bamboo outlier 
z_scores <- scale(LAI_earlyxbiomass_seasons$grass_mass)
outliers <- abs(z_scores) > 3  # Adjust the threshold as needed

# Create a subset without outliers
data <- LAI_earlyxbiomass_seasons[!outliers, ]

#PLOT
gamm_data <- expand.grid(mean_LAI = seq(min(data$mean_LAI), max(data$mean_LAI), length = 100),
                        season = unique(data$season),
                        plot_id = unique(data$plot_id))

# Make predictions using the GAM model
gamm_data$predicted <- predict(gam_model_tw, newdata = gamm_data, type = "response")


# Create a plot using ggplot2
ggplot(gamm_data, aes(x = mean_LAI, y = predicted, color = season)) +
  geom_line()+
  geom_point(data = data, aes(x = mean_LAI, y = grass_mass, color = season), alpha = 0.5) +
  labs(title = "Seasonal Difference Grass Load Across Canopy Gradient (GAM)",
       x = "Canopy Cover (Early Season LAI)",
       y = "Grass Load (g/m2)") +
  geom_hline(yintercept = 200, linetype = "dashed") +
  theme_minimal()

```
**1.2.1b Changing LAI)**

```{r 1.2.1b setup, include = FALSE}
#we have the early season LAI in LAI_early, now we need to add late season LAI (LAI_late) to create LAI_early_late. We do this rather than using the complete LAI data, as we need 50 + 50 LAI obs that are most representative of LAI at time of collection to pair with the 50 + 50 biomass obs.

LAI_early <- LAI %>%
  group_by(plot_id, quad_id, plot_type, season) %>%
  filter(obs_period == "1" | obs_period == "2") %>% 
  summarise(mean_LAI = mean(LAI))

#to make LAI late, I'm going to do the same thing as LAI_early but with obs 7 & 8, which were the closest LAI obs to the late biomass obs.
LAI_late <- LAI %>%
  group_by(plot_id, quad_id, plot_type, season) %>%
  filter(obs_period == "7" | obs_period == "8") %>% 
  summarise(mean_LAI = mean(LAI, na.rm = TRUE))

#now to stack these LAI dfs on top of each other
LAI_seasons <- bind_rows(LAI_early, LAI_late)

#merging LAI_early and biomass_1 into LAIxbiomass_2
LAIxbiomass_seasons <- right_join(LAI_seasons, biomass_seasons, by = c("plot_id", "quad_id", "season"))

#drop the quadrants that did not have biomass records
LAIxbiomass_seasons <- LAIxbiomass_seasons %>% drop_na(grass_mass)

#make season a factor
LAIxbiomass_seasons$season <- factor(LAIxbiomass_seasons$season)

#make plot_id a factor
LAIxbiomass_seasons$plot_id <- factor(LAIxbiomass_seasons$plot_id)


```

```{r 1.2.1b GAM_tweedie}
## same GAM as in part a but with seasonal LAI values to match the grass obs

# Creating a GAM model
gam_model_twb <- gam(grass_mass ~ season + s(mean_LAI, by = season),
                    family = tw(link = "log"), data = LAIxbiomass_seasons, method = "REML")
                    
summary(gam_model_twb)
k.check(gam_model_twb)
gam.check(gam_model_twb)

```

```{r 1.2.1b GAMM_tweedie}
## Now try adding a random effect for plot_id

# Creating a GAM model with a random intercept for 'plot_id'
gamm_model_twb <- gam(grass_mass ~ season + s(mean_LAI, by = season) + s(plot_id, bs = "re"),
                    family = tw(link = "log"), data = LAIxbiomass_seasons, method = "REML")
                    
summary(gamm_model_twb)
k.check(gamm_model_twb)
gam.check(gamm_model_twb)


#Comparing the GAM and the GAMM
AIC(gam_model_twb, gamm_model_twb)

```

```{r 1.2.1 GAMM plot}

#remove huge bamboo outlier 
z_scores <- scale(LAIxbiomass_seasons$grass_mass)
outliers <- abs(z_scores) > 3  # Adjust the threshold as needed

# Create a subset without outliers
data <- LAIxbiomass_seasons[!outliers, ]

#PLOT
gamm_data <- expand.grid(mean_LAI = seq(min(data$mean_LAI), max(data$mean_LAI), length = 100),
                        season = unique(data$season),
                        plot_id = unique(data$plot_id))

# Make predictions using the GAM model
gamm_data$predicted <- predict(gam_model_twb, newdata = gamm_data, type = "response")


# Create a plot using ggplot2
ggplot(gamm_data, aes(x = mean_LAI, y = predicted, color = season)) +
  geom_line()+
  geom_point(data = data, aes(x = mean_LAI, y = grass_mass, color = season), alpha = 0.5) +
  labs(title = "Seasonal Difference in ROS and LAI (GAMM)",
       x = "LAI",
       y = "grass") +
  geom_hline(yintercept = 180.4, linetype = "dashed") +
  theme_minimal()

```

#### 1.2.2) LM: Changes in litter load across the dry season

Over the course of a dry season the distinction between open and closed surface fuel loads [decreases]{.underline} as all deciduous and most evergreen trees (to a lesser magnitude) drop their leaves (Williams 2008), adding to the litter component of the surface fuel composition. The timing of senescence is highly variable among species in seasonal tropical forests, but over the season the result is the ultimately the same: As the dry season progresses, more fuel is added to the surface in the form of litter, packing surface fuels more densely.

For 1.2.2 analysis, we will use the same tables created in 1.2.1a and 1.2.1b but replace the grass_mass with the litter parameters. The models will look the same as in 1.2.1 with an interaction between LAI and the fuel variable.

**1.2.2a)**

```{r 1.2.2a setup, include=FALSE}
#pull "LAI_earlyxbiomass_seasons" from 1.2.1a
head(LAI_earlyxbiomass_seasons)
```

For now the model is simple linear rather than mixed effects (with random effect for plot) because idk how to do mixed effects with an interacting non-numeric term.

```{r 1.2.2a model}
# linear model with interaction between litter and LAI 
model <- lm(litter_mass ~ mean_LAI*season, data = LAI_earlyxbiomass_seasons)
summary(model)
```

```{r 1.2.2a plot}
ggplot(LAI_earlyxbiomass_seasons, aes(x = mean_LAI, y = litter_mass, color = season)) +
  geom_point() +
  geom_smooth(method = "lm", formula = y ~ x, se = FALSE) +
  labs(title = "Seasonal Litter Loads Across the Canopy Gradient (LAI Fixed)",
       x = "LAI", y = "Litter Load (g/m2)", color = "Season") +
  theme_minimal()    
```

**1.2.2b)** Now, we will write a model that temporally pairs biomass and LAI obs, so early season litter will be paired with early season LAI obs and late season litter will be paired with late season LAI obs. Where method 1.2.2a was useful for looking at surface fuel change, this method will concentrate on the relationship between canopy cover and litter, as both canopy cover and litter change across the season.

```{r 1.2.2b setup, include = FALSE}
#pull "LAIxbiomass_seasons" from 1.2.1b
head(LAIxbiomass_seasons)
```

For now the model is simple linear rather than mixed effects (with random effect for plot) because idk how to do mixed effects with an interacting non-numeric term.

```{r 1.2.2b model}
# linear model with interaction between litter and LAI 
model <- lm(litter_mass ~ mean_LAI*season, data = LAIxbiomass_seasons)
summary(model)
```

From both 1.2.2 models we see that the "seasonlate" terms, the intercept differences between seasons, are significant. The late season has much more litter than the early season no matter where you are on the canopy gradient. From the interaction term (mean_LAI:seasonlate) we see minor significance in 1.2.2a and no significance in 1.2.2b. This tells us that the slopes of the two seasons are not much different, but we can see that the late season slope is slightly steeper (explaining the almost significance) which makes sense as there are more trees and thus more potential for litter in the closed canopy.

```{r 1.2.2b plot}
ggplot(LAIxbiomass_seasons, aes(x = mean_LAI, y = litter_mass*4, color = season))+
  geom_point() +
  geom_smooth(method = "lm", formula = y ~ x, se = FALSE) +
  labs(title = "Seasonal Litter Loads Across Canopy Gradient",
       x = "LAI", y = "Litter Load (g/m2)", color = "Season") +
  theme_minimal()   

```
#### 1.2.2) GAM: Changes in litter load across the dry season

**1.2.2a GAM) Fixed LAI**

```{r 1.2.2a setup, include=FALSE}
#pull "LAI_earlyxbiomass_seasons" from 1.2.1a
head(LAI_earlyxbiomass_seasons)
```

```{r 1.2.2a GAM}
#make season a factor
LAI_earlyxbiomass_seasons$season <- factor(LAI_earlyxbiomass_seasons$season)

#make plot_id a factor
LAI_earlyxbiomass_seasons$plot_id <- factor(LAI_earlyxbiomass_seasons$plot_id)

gam_model <- gam(litter_mass ~ season + s(mean_LAI, by = season),  family = tw(link = "log"),
           data = LAI_earlyxbiomass_seasons, method = "REML")

summary(gam_model)
k.check(gam_model)
gam.check(gam_model)
```

The assumptions from the gam.check are looking pretty good so no need to change distribution or basis.
We'll see how adding the random factor looks.

```{r 1.2.2a GAMM}
## Now try adding a random effect for plot_id

# Creating a GAM model with a random intercept for 'plot_id'
gamm_model <- gam(litter_mass ~ season + s(mean_LAI, by = season) + s(plot_id, bs = "re"),
                    family = tw(link = "log"), data = LAI_earlyxbiomass_seasons, method = "REML")
                    
summary(gamm_model)
k.check(gamm_model)
gam.check(gamm_model)


#Comparing the GAM and the GAMM
AIC(gam_model, gamm_model)
```

The GAM has lower AIC and slightly better so we'll stick with that for now for the plot.
```{r 1.2.2a GAM plot}

data <- LAI_earlyxbiomass_seasons

#PLOT
gam_data <- expand.grid(mean_LAI = seq(min(data$mean_LAI), max(data$mean_LAI), length = 100),
                        season = unique(data$season))

# Make predictions using the GAM model
gam_data$predicted <- predict(gam_model, newdata = gam_data, type = "response")


# Create a plot using ggplot2
ggplot(gam_data, aes(x = mean_LAI, y = predicted, color = season)) +
  geom_line()+
  geom_point(data = data, aes(x = mean_LAI, y = litter_mass, color = season), alpha = 0.5) +
  labs(title = "Seasonal Difference in Litter Load Across Canopy Cover (GAM)",
       x = "Canopy Cover (Early Season LAI)",
       y = "Litter Load (g/m2)") +
  theme_minimal()

```

**1.2.2b GAM) Changing Seasonal LAI**

```{r 1.2.1b GAM}
## same GAM as in part a but with seasonal LAI values to match the grass obs

# Creating a GAM model
gam_modelb <- gam(litter_mass ~ season + s(mean_LAI, by = season),
                    data = LAIxbiomass_seasons, method = "REML")
                    
summary(gam_modelb)
k.check(gam_modelb)
gam.check(gam_modelb)

```

```{r 1.2.2a GAM plot}
data <- LAIxbiomass_seasons

#PLOT
gam_data <- expand.grid(mean_LAI = seq(min(data$mean_LAI), max(data$mean_LAI), length = 100),
                        season = unique(data$season))

# Make predictions using the GAM model
gam_data$predicted <- predict(gam_modelb, newdata = gam_data, type = "response")


# Create a plot using ggplot2
ggplot(gam_data, aes(x = mean_LAI, y = predicted, color = season)) +
  geom_line()+
  geom_point(data = data, aes(x = mean_LAI, y = litter_mass, color = season), alpha = 0.5) +
  labs(title = "Seasonal Difference in Litter and LAI (GAM)",
       x = "LAI",
       y = "Litter Load (g/m^2") +
  theme_minimal()

```

#### 1.2.3) Fine Fuel Load across the dry season
The densely treed savannas of Northern Cambodia may require extra consideration of the litter component of their surface fuel makeup, when considering their potential fire effects. In less treed savannas, grass connectivity is sometimes considered in isolation - as then sole source of surface fuel. To ignore litter at Khun Ream would be to ignore half of the fine fuel makeup, and to ignore the seasonal dynamics of surface fuel.

We will look at the total fine fuel loads (grass + litter) in the early and late season to better understand how the fuel load shifts from grass dominated to litter dominated.

```{r 1.2.3 setup}
#fine fuel mass----
biomass_fine <- biomass %>% 
  mutate(fine_mass = mass_grass + mass_litter)

biomass_fine <- biomass_fine %>%
  group_by(plot_id, quad_id, season) %>% 
  summarise( fine_mass = mean(fine_mass))

LAI_earlyxbiomass_fine <- right_join(LAI_early, biomass_fine, by = c("plot_id", "quad_id"))

#drop the quadrants that did not have biomass records
LAI_earlyxbiomass_fine <- LAI_earlyxbiomass_fine %>% drop_na(fine_mass)

##setup for 1.2.3b

LAIxbiomass_fine <- right_join(LAI_seasons, biomass_fine, by = c("plot_id", "quad_id", "season"))

#drop the quadrants that did not have biomass records
LAIxbiomass_fine <- LAIxbiomass_fine %>% drop_na(fine_mass)
```

```{r 1.2.3a model}
# linear model with interaction between litter and LAI 
model <- lm(fine_mass ~ mean_LAI*season.y, data = LAI_earlyxbiomass_fine)
summary(model)
```

```{r 1.2.3a plot}
ggplot(LAI_earlyxbiomass_fine, aes(x = mean_LAI, y = fine_mass*4, color = season.y))+
  geom_point() +
  geom_smooth(method = "lm", formula = y ~ x, se = FALSE) +
  labs(title = "Seasonal Fine Fuel Loads Across Canopy Gradient (LAI Fixed)",
       x = "LAI", y = "Fine Fuel Load (g/m2)", color = "Season") +
  ylim(0, 1.3) +
  theme_minimal()   

```

```{r 1.2.3b model}
# linear model with interaction between litter and LAI 
model <- lm(fine_mass ~ mean_LAI*season, data = LAIxbiomass_fine)
summary(model)
```

```{r 1.2.3b plot}
ggplot(LAIxbiomass_fine, aes(x = mean_LAI, y = fine_mass*4, color = season))+
  geom_point() +
  geom_smooth(method = "lm", formula = y ~ x, se = FALSE) +
  labs(title = "Seasonal Fine Fuel Loads Across Canopy Gradient",
       x = "LAI", y = "Fine Fuel Load (kg/m2)", color = "Season") +
  ylim(0, 1.3) +
  theme_minimal()   

```
The key here is that between the early and late season there is a dramatic shift from a grass dominated to litter dominated fine fuel loads in the open canopy. There is a large litter component in our system compared to savanna-forest mosaics elsewhere. In both the savanna and the forest, we see ~doubling of litter loads that, when paired with decreasing grass loads, result in similar fine fuel loads across the canopy gradient (in the late season) compared to the declining fine fuel loads in the early season where grasses are at annual maximums and most litter has yet to fall. The consequences on fire likelihood from this seasonal change in fine fuel composition will be discussed in the following modeling chapter. 

#### 1.2.3) GAM: Fine fuel Load across the dry season
```{r 1.2.3 setup}
#fine fuel mass----
biomass_fine <- biomass %>% 
  mutate(fine_mass = mass_grass + mass_litter)

biomass_fine <- biomass_fine %>%
  group_by(plot_id, quad_id, season) %>% 
  summarise( fine_mass = mean(fine_mass)*4)

LAI_earlyxbiomass_fine <- right_join(LAI_early, biomass_fine, by = c("plot_id", "quad_id"))

#drop the quadrants that did not have biomass records
LAI_earlyxbiomass_fine <- LAI_earlyxbiomass_fine %>% drop_na(fine_mass)

##setup for 1.2.3b

LAIxbiomass_fine <- right_join(LAI_seasons, biomass_fine, by = c("plot_id", "quad_id", "season"))

#drop the quadrants that did not have biomass records
LAIxbiomass_fine <- LAIxbiomass_fine %>% drop_na(fine_mass)

#make season a factor
LAIxbiomass_fine$season <- factor(LAIxbiomass_fine$season)

#make plot_id a factor
LAIxbiomass_fine$plot_id <- factor(LAIxbiomass_fine$plot_id)
```

```{r 1.2.3 GAM}
#remove huge bamboo outlier 
z_scores <- scale(LAIxbiomass_fine$fine_mass)
outliers <- abs(z_scores) > 3  # Adjust the threshold as needed

# Create a subset without outliers
data <- LAIxbiomass_fine[!outliers, ]


gam_model <- gam(fine_mass ~ season + s(mean_LAI, by = season), 
           data = data, method = "REML")

summary(gam_model)
k.check(gam_model)
gam.check(gam_model)
```


```{r 1.2.3 GAMM}
gamm_model <- gam(fine_mass ~ season + s(mean_LAI, by = season) + s(plot_id, bs = "re"),
                   data = data, method = "REML")

summary(gamm_model)
k.check(gamm_model)
gam.check(gamm_model)
```

```{r 1.2.3 plot}

#PLOT
gamm_data <- expand.grid(mean_LAI = seq(min(data$mean_LAI), max(data$mean_LAI), length = 100),
                        season = unique(data$season), plot_id = unique(data$plot_id))


# Make predictions using the GAM model
gamm_data$predicted <- predict(gamm_model, newdata = gamm_data, type = "response")


# Create a plot using ggplot2
ggplot(gamm_data, aes(x = mean_LAI, y = predicted, color = season)) +
  geom_line()+
  geom_point(data = data, aes(x = mean_LAI, y = litter_mass, color = season), alpha = 0.5) +
  labs(title = "Seasonal Difference in Litter and LAI (GAM)",
       x = "LAI",
       y = "Litter Load (g/m^2") +
  theme_minimal()
```

#### 1.2.4) Changes in fine fuel bulk density across the dry season
Before, in 1.1.3, we saw that fine fuel bulk density increases linearly from open to closed canopy. As the fuel component switches from being grass dominated to leaf litter dominated in the late season, I expect to see the fine fuel bulk density slope **decrease** 

First we add volume for grass and litter given the areas of coverage (determined from percent cover) and the heights for each quadrat:

```{r 1.2.4 setup (Frustum)}
#fine fuel mass----
biomass_bulk <- biomass %>% 
  mutate(fine_mass = grass_mass/1000 + litter_mass/1000)
#grass volume ----
#need to convert h to m from cm
biomass_bulk <- biomass_bulk %>% 
  mutate(grass_height = grass_height/100, litter_depth = litter_depth/100)

#Define top and bottom area for the Frustum
A1 = 3.1459*(.5*(biomass_bulk$grass_height/1.5))^2
A2 = ((biomass_bulk$grass_per/100)*.25)

#Add new grass volume to df
biomass_bulk <- biomass_bulk %>% 
  mutate(grass_volume = ((grass_height/3)* (A1 + A2 + sqrt(A1 * A2))))

#litter volume ----
biomass_bulk <- biomass_bulk %>% 
  mutate(litter_volume = .25 * (biomass_bulk$litter_per/100) * biomass_bulk$litter_depth)

#fine fuel volume ----
biomass_bulk <- biomass_bulk %>% 
  mutate(fine_volume = grass_volume + litter_volume)

#fine fuel bulk density ----
biomass_bulk <- biomass_bulk %>% 
  mutate(bulk_density = fine_mass/fine_volume)


### Make biomass_seasons again with our new volume and bulk data----
biomass_bulk <- biomass_bulk %>%
   group_by(plot_id, quad_id, season) %>% 
  summarise(grass_mass = mean(grass_mass), litter_mass = mean(litter_mass), wood_mass = mean(wood_mass), other_mass = mean(other_mass), grass_height = mean(grass_height), litter_depth = mean(litter_depth), grass_per = mean(grass_per), litter_per = mean(litter_per), bulk_density = mean(bulk_density))

LAI_earlyxbiomass_bulk <- right_join(LAI_early, biomass_bulk, by = c("plot_id", "quad_id"))

#drop the quadrants that did not have biomass records
LAI_earlyxbiomass_bulk <- LAI_earlyxbiomass_bulk %>% drop_na(grass_mass)

```


Using dry biomass for now but need to use wet mass = 100 later to make the grass biomass consistent with behave plus
```{r 1.2.4 setup (Whole quad)}

bulk <- LAI_earlyxbiomass_seasons %>%
  mutate(bulk_density = ifelse(grass_mass > 20, (grass_mass+litter_mass)/ (grass_height/100), (grass_mass+litter_mass)/ (litter_depth/100)))

#remove huge bamboo outlier 
z_scores <- scale(bulk$bulk_density)
outliers <- abs(z_scores) > 3  # Adjust the threshold as needed

# Create a subset without outliers
bulk <- bulk[!outliers, ]

model <- lmer(bulk_density ~ mean_LAI*season + (1|plot_id) , data = bulk)
summary(model)


```



**1.2.4a)**

```{r 1.2.4a plot}
ggplot(bulk, aes(x = mean_LAI, y = bulk_density/1000, color = season))+
  geom_point() +
  geom_smooth() +
  labs(title = "Seasonal Bulk Density Across the Tree Cover Gradient",
       x = "LAI", y = "Fine Fuel Bulk Density (g/m3)", color = "Season") +
  theme_minimal() 

```
**1.2.4b)**
```{r 1.2.4b analysis}
model <- lm(bulk_density ~ mean_LAI*season, data = LAIxbiomass_bulk)
summary(model)
```

``` {r 1.2.4b plot}
ggplot(LAIxbiomass_bulk, aes(x = mean_LAI, y = bulk_density, color = season))+
  geom_point() +
  geom_smooth(method = "lm", formula = y ~ x, se = FALSE) +
  labs(title = "Seasonal Bulk Density Across the Tree Cover Gradient",
       x = "LAI", y = "Fine Fuel Bulk Density (kg/m3)", color = "Season") +
  theme_minimal() 

```

## Q2: 1) How does surface microclimate vary with canopy cover? 2) How does this relationship change throughout the dry season?

In Q1 we looked at how fuel is distributed along the canopy gradient, in that question we were essentially looking at fuel availability in terms of the physical presence of flammable vegetation. At the coarsest scale, fuel presence is determined by climate (Meyn 2007). In our system, the precipitation is sufficient to support continuous vegetation and the presence of fuel is largely moderated through site-specific edaphic conditions and fire-feedbacks (Pausas, ref..) ( see outline). Once present or absent, fuel amount tends to change due to relatively slow process (growth and decay), unless it is removed by a consumer (fire, grazer, or otherwise). In the absence of cow or fire, surface fuels will accumulate gradually with leaf fall (dry season) or new herbaceous growth (wet season) or decrease gradually through dessication.

Contrastingly, weather can affect surface fuel on a finer temporal scale (ref). Weather affects fuel availability through daily fluctuations in temperature and RH, so that fuel that is not available to burn at 0900, may be quite flammable at 1700. However, weather also acts on coarser scales, and it may take weeks or months of drought to dry fuels sufficiently to sustain fire, particularly in moist (high RH) and mesic-dense canopied systems. Atmospheric moisture is absorbed by fuels, particularly dead fuels, and tree canopies buffer surface fuel conditions by moderating microclimates under the canopy. Wet fuel is not available to fire, no matter how much fuel there is. So after they are saturated, fuels must dry sufficiently before they can be available to fire. The threshold fuel moisture at which combustion can be sustained is referred to as the **moisture of extinction.** The moisture of extinction is dependent on fuel composition, fuel amount, and fuel structure (ref), therefore, it is variable throughout the season as the orientation of fuels changes (as described in Q1) (ref. I know this is explicitly stated but i cant find it). The time it takes for a fuel parcel to cross the moisture of extinction and become dry enough for combustion is dependent on several interacting factors ( need to elaborate on this, perhaps, see the fuel moisture section in annotated bib ), most relevant of which is **microclimate buffering** (ref). Fuels that are under a dense canopy take longer to dry (longer to cross the moisture of extinction) than fuels that are in the open exposed to direct sunlight. Therefore, if we take two identical fuels, one shaded and one unshaded, the unshaded fuel will be able to ignite, or "available" to fire quicker than the shaded fuel. This is really fundamental stuff, but I find that breaking the fire process down to its most basic principals helps in understanding the different roles of fuel structure and fuel microclimate. In Q2, we are concerned with this more mercurial side of fuel availability: the components of fuel availability that are determined by **microclimate.**

Tree canopies moderate microclimate by acting as a thermal insulator, buffering surface fuels from atmospheric extremes (Frenne 2019). In a Dipterocarp fire regime, a closed canopy will restrict light availability at the forest floor resulting in wetter midday fuels and lower relative fuel availability. In contrast, the microclimates of open systems promote flammability at the surface as radiation passes through gaps in the canopy, drying surface fuels with the rising of the sun each day.

### 2.1) How does surface microclimate vary with canopy cover?

Past research suggests that relationships between canopy cover and microclimate buffering tend to be linear in tropical forest systems (Hardwick 2015). But extent of buffering, or the slope of microclimate buffering across the canopy gradient should increase as free-air (open-canopy) temperatures increase. Basically, as macroclimate heat or open-air heat temperatures get more extreme, open canopies should be relatively worse bufferers and closed canopies should be relatively better bufferers, exaggerating the differences in microclimate between open and closed systems (Davis 2018, De Frenne 2019).

#### 2.1.1) Average of peak weather hours across canopy cover over season

In this analysis we will be looking at the relationship between microclimate and canopy cover across the two scales that are most important for understanding the role of microclimate in determining fuel availability: daily scales and seasonal scales. We will pair each LAI obs with an average of the daytime (1100 - 1700) and nighttime (0000-0600) surface temp, soil temp, and soil moisture, for a total of 46(quadrants) \* 8(LAI observations) = 368 rows.

```{r 2.1.1 setup, include = FALSE}
LAI <- read_csv("C:/Users/d/Desktop/UBC 2023/Robinson-Project-MSc/KH_data/LAI/LAI_V1.csv", 
     col_types = cols(date = col_date(format = "%m/%d/%Y"), 
      obs_period = col_character(), LAI = col_number(), 
      month = col_character()))

#Turn obs_period into a factor class variable
LAI$obs_period <- factor(LAI$obs_period)


TOMST_V1 <- read_csv("C:/Users/d/Desktop/UBC 2023/Robinson-Project-MSc/KH_data/TOMST/TOMST_V1.csv", 
    col_types = cols(date = col_date(format = "%Y.%m.%d"), 
        date_time = col_datetime(format = "%Y.%m.%d %H:%M"), 
        air_temp = col_number(), soil_moisture = col_number()))


#Initially I had tried to filter the temps around the heat of the day, but had an issue where in the early season some of the loggers time zones were not calibrated, so instead we look at daily max and min, which is more aligned with the literature we are comparing to anyway. 
TOMST_filter <- TOMST_V1 %>%
  group_by(date, plot_id, quad_id, plot_type) %>%
  summarize(max_air_temp = max(air_temp), min_air_temp = min(air_temp), max_surface_temp = max(surface_temp), min_surface_temp = min(surface_temp),
            max_soil_temp = max(soil_temp), min_soil_temp = min(soil_temp), max_soil_moisture = max(soil_moisture), min_soil_moisture = min(soil_moisture))

#Filter for the dates that match the LAI records
TOMST_2.1 <- TOMST_filter %>% 
  filter(date %in% c("2023-01-25", "2023-01-26", "2023-01-27",  "2023-02-03", "2023-02-02", "2023-02-04","2023-02-07", "2023-02-08", "2023-02-09", "2023-02-16", "2023-02-17", "2023-02-18", "2023-02-27", "2023-02-28", "2023-02-29", "2023-03-13", "2023-03-14", "2023-03-15", "2023-03-28", "2023-03-29",
                     "2023-03-30", "2023-04-09", "2023-04-10", "2023-04-11"))

#create obs_periods for easy merge with LAI, because some LAI were collected over two days
TOMST_2.1 <- TOMST_2.1 %>%
  mutate(obs_period = case_when(
    date %in% c("2023-01-25", "2023-01-26", "2023-01-27") ~ "1", date %in% c("2023-02-03", "2023-02-02", "2023-02-04") ~ "2",  date %in% c("2023-02-07", "2023-02-08", "2023-02-09") ~ "3", 
    date %in% c("2023-02-16", "2023-02-17", "2023-02-18") ~ "4",  date %in% c("2023-02-27", "2023-02-28", "2023-02-29") ~ "5",  date %in% c("2023-03-13", "2023-03-14", "2023-03-15") ~ "6",
     date %in% c("2023-03-28", "2023-03-29", "2023-03-30") ~ "7",  date %in% c("2023-04-09", "2023-04-10", "2023-04-11") ~ "8"
  ))

#turn obs_period into factor class variable
TOMST_2.1$obs_period <- factor(TOMST_2.1$obs_period)

#Average the values for the obs_periods that have 2 dates
TOMST_2.1 <- TOMST_2.1 %>% 
group_by(plot_id, quad_id, obs_period) %>% 
  summarize(max_soil_temp = mean(max_soil_temp), min_soil_temp = mean(min_soil_temp), 
            max_surface_temp = mean(max_surface_temp), min_surface_temp = mean(min_surface_temp),
            max_air_temp = mean(max_air_temp), min_air_temp = mean(min_air_temp),
            max_soil_moist = mean(max_soil_moisture), min_soil_moist = mean(min_soil_moisture))

LAIxTOMST2.1 <- TOMST_2.1 %>% 
  left_join(LAI, by = c("quad_id", "plot_id", "obs_period"))

```

```{r 2.1.1 plot}

facet_labels <- c("Jan 26", "Feb2", "Feb 8", "Feb 17", "Feb 28", "Mar 14", "Mar 29", "Apr 11")
names(facet_labels) <- c("1", "2", "3", "4", "5", "6", "7", "8")

ggplot(LAIxTOMST2.1, aes(x = LAI, y = max_air_temp, color = obs_period)) +
  geom_point() +
  geom_smooth(fill = NA) +
   facet_wrap(~obs_period, labeller = labeller(obs_period = facet_labels))+
  labs(x = "LAI", y = "Max Daily Air Temperature (Celsius)", color = "Observation",
       title = "Surface Microclimate Temps Controlled by LAI Across Season") +
  theme_bw()
```

```{r 2.1.1 data analysis, include=FALSE}
#Here we will get the slope of each 
slope2.1.1 <- LAIxTOMST2.1 %>%
  group_by(obs_period) %>%
  do(model = lm(max_air_temp ~ LAI, data = .)) %>%
  summarize(obs_period, slope = coef(model)[2])     #coef[2] extracts just the slope from the huge list that results from the lm()

ggplot(slope2.1.1, aes(x= obs_period, y=slope))+
         geom_point() + stat_smooth(fill = "NA", color = "brown")

#obs_period converted to numeric from factor to do lm
slope2.1.1$obs_period <- as.numeric(as.character(slope2.1.1$obs_period))

model2.1.1 <- lm(slope ~ obs_period, data = slope2.1.1)
```

``` {r 2.1.1 model summary}
# View the model summary
summary(model2.1.1)
```

Across the season, as the temperatures increase and yearly temperature extremes set in, the relationship between microclimate and canopy cover did *not* change. There is no relationship evidenced by the slopes of the different obs periods. This is in contrast with many microclimate buffering studies (De Frenne, Davis) that suggest that microclimate buffering from canopies should become more polarized between open and closed systems as temperatures increase. We see no change in slope related to microclimate over the dry season, despite seeing max daily temperature increases of up to 10 C.

I'm going to look at the same thing but if you keep canopy cover static, so looking at each logger as a fixed point to understand how the microclimate changes over the season for a fixed surface location. 

```{r 2.1.2 setup}
LAI_early <- LAI %>%
  group_by(plot_id, quad_id, plot_type, season) %>%
  filter(obs_period == "1" | obs_period == "2") %>% 
  summarise(LAI = mean(LAI))

LAIxTOMST2.1.2 <- TOMST_2.1 %>% 
  left_join(LAI_early, by = c("quad_id", "plot_id"))
```
```{r 2.1.2 observations plot}
#Plot
facet_labels <- c("Jan 26", "Feb2", "Feb 8", "Feb 17", "Feb 28", "Mar 14", "Mar 29", "Apr 11")
names(facet_labels) <- c("1", "2", "3", "4", "5", "6", "7", "8")

ggplot(LAIxTOMST2.1.2, aes(x = LAI, y = max_air_temp, color = obs_period)) +
  geom_point() +
  geom_smooth(fill = NA) +
  facet_wrap(~obs_period, labeller = labeller(obs_period = facet_labels)) +
  labs(x = "LAI", y = "Max Daily Air Temperature (Celsius)", color = "Observation",
       title = "Slope steepest in mid season (late Feb) before EVG lose leaves") +
  theme_bw()

```

```{r 2.1.2 analysis}
slope2.1.2 <- LAIxTOMST2.1.2 %>%
  group_by(obs_period) %>%
  do(model = lm(max_air_temp ~ LAI, data = .)) %>%
  summarize(obs_period, slope = coef(model)[2])     #coef[2] extracts just the slope from the huge list that results from the lm()

ggplot(slope2.1.2, aes(x= obs_period, y=slope))+
         geom_point() + stat_smooth(fill = NA, colour="brown")

#obs_period converted to numeric from factor to do lm
slope2.1.2$obs_period <- as.numeric(as.character(slope2.1.2$obs_period))

model2.1.2 <- lm(slope ~ obs_period, data = slope2.1.2)
summary(model2.1.2)

```

This is actually pretty cool. There is a steeper slope in the early to midseason prior to a sort of *tipping point* in microclimate around late Feb likely coinciding with the beginning of a big leaf shedding event which is why this relationship is evident in this graph where canopy cover is static and not in the previous chart where LAI cahnges with each ob.



### 2.2) How does the relationship between fuel moisture and canopy cover change throughout the dry season?

#### 2.2.1) Fuel moisture across the canopy gradient: averaged across the season

```{r 2.2.1 setup, include = FALSE}
#fm_V5 comes from the work shown in Q3.1
fm <- read_csv("C:/Users/d/Desktop/UBC 2023/Robinson-Project-MSc/KH_data/Fuel-Moisture/fm_V5.csv", 
    col_types = cols(date = col_date(format = "%Y-%m-%d"), grass = col_number(), woody_leaf = col_number(),litter = col_number(), hundred_hr = col_number(), ten_hr = col_number(), one_hr = col_number()))

#make plot_id a factor
fm$plot_id <- factor(fm$plot_id)

#make obs_period a factor
fm$obs_period <- factor(fm$obs_period)

#averaging across all obs
fm_avg <- fm %>% 
 group_by(plot_id, quad_id) %>%
  summarise(woody_leaf = mean(woody_leaf, na.rm = TRUE), grass = mean(grass, na.rm = TRUE), litter = mean(litter, na.rm = TRUE), ten_hr = mean(ten_hr, na.rm = TRUE), hundred_hr = mean(hundred_hr, na.rm = TRUE))


# Bring in LAI data
LAI <- read_csv("C:/Users/d/Desktop/UBC 2023/Robinson-Project-MSc/KH_data/LAI/LAI_V1.csv", 
    col_types = cols(date = col_date(format = "%m/%d/%Y"), 
        LAI = col_number()))

LAI$season <- factor(LAI$season)

#make plot_id a factor
LAI$plot_id <- factor(LAI$plot_id)

#make obs_period a factor
LAI$obs_period <- factor(LAI$obs_period)

#isolating and averaging LAI ob 1&2  data across all observations for one value per quadrant (n=50)
LAI_avg <- LAI %>%
  group_by(plot_id, quad_id) %>% 
  summarise(mean_LAI = mean(LAI, na.rm = TRUE))

#merge LAI_early and fm_avg for LAIxfm
LAIxfm_avg <- left_join(LAI_avg, fm_avg, by = c("quad_id", "plot_id"))

```

```{r season average fm data analysis}

model <- lmer(litter ~ mean_LAI + (1|plot_id), data = LAIxfm)
summary(model)

```

```{r season average fm plot}
# Extract the prediction data frame
pred <- ggpredict(model, terms = c("mean_LAI"))  # this gives overall predictions for the model

# Plot the predictions 

(ggplot(pred) + 
   geom_line(aes(x = x, y = predicted), color = "red") +          # slope
   geom_ribbon(aes(x = x, ymin = predicted - std.error, ymax = predicted + std.error), 
               fill = NA, alpha = 0.5) +  # error band
   geom_point(data = LAIxfm,                # adding the raw data
              aes(x = LAIxfm$mean_LAI, y = (LAIxfm$litter))) + 
   labs(x = "LAI", y = "Litter Fuel Mositure (%)", 
        title = "Litter Fuel Mositure Increases Linearly Across Canopy Gradient") + 
   theme_bw()
)


```

#### 2.2.2) Fuel moisture across canopy cover, by observation period (across the dry season)

I've got times for the collection of fuel moisture from the field for Feb 16 and Mar 30 so I will compare those times to the fuel moistures and calibrate? them accordingly. Since fuels at 11:00 cant reasonably be compared with fuels from 16:00.

16/2/23: EVG1 - 12:00, EVG2 - 11:15, EVG3 - 16:30, EVG4 - 13:30, EVG5 - 17:50, DDF2 - 14:40, DDF3 - 17:10, DDF4 - 10:45, DDF5 - 14:00, DDF6 - 1600

29/3/23: EVG1 - 12:00, EVG2 - 11:15, EVG4 - 13:30, DDF2 - 16:40, DDF4 - 14:00, DDF5 - 14:45, DDF6 - 1600

30/3/23: EVG3 - 12:00, DDF3 - 11:30, EVG5 - 10:50
```{r 2.2.2 setup, include = FALSE}
#fm_V5 comes from the work shown in Q3.1 plus additions described in FMC readme
library(readr)
fm_V5 <- read_csv("C:/Users/d/Desktop/UBC 2023/Robinson-Project-MSc/KH_data/Fuel-Moisture/fm_V5.csv", 
    col_types = cols(date = col_date(format = "%m/%d/%Y"), 
        obs_period = col_factor(levels = c("0", 
        "1", "2", "3", "4", "5", "6", "7")), plot_type = col_character(), 
        grass = col_number(), woody_leaf = col_number(), 
        litter = col_number(), hundred_hr = col_number(), 
        ten_hr = col_number(), one_hr = col_number()))

# Bring in LAI data
LAI <- read_csv("C:/Users/d/Desktop/UBC 2023/Robinson-Project-MSc/KH_data/LAI/LAI_V1.csv", 
    col_types = cols(date = col_date(format = "%m/%d/%Y"), 
        LAI = col_number(),
        obs_period = col_factor(levels = c("0","1", "2", "3", "4", "5", "6", "7"))))

#merge LAI_early and fm_avg for LAIxfm
LAIxfm_obs <- left_join(fm, LAI, by = c("quad_id", "plot_id", "obs_period", "plot_type"))


```

```{r 2.2.2 litter fm plot}
#For litter, restrict to obs 4-7, because we didn't get sufficient litter prior to obs 4
litter2.2 <- LAIxfm_obs %>% 
  filter(obs_period %in% c("4", "5", "6", "7"))

ggplot(litter2.2, aes(x = LAI, y = litter, color = obs_period)) +
  geom_point() + geom_smooth(fill = "NA", method = "lm", aes(color = obs_period)) +
  scale_color_manual(values = c("4" = "red", "5" = "blue", "6" = "green", "7" = "purple"),
    labels = c("4" = "16 Feb", "5" = "1 Mar", "6" = "13 Mar", "7" = "30 Mar")) +
      labs(x = "LAI", y = "Litter Fuel Mositure (%)", color = "Date",
        title = "Litter Fuel Mositure Slope Decreases in Late Season") + 
   theme_bw()


#Just those show in behave plus
litter2.2 <- LAIxfm_obs %>% 
  filter(obs_period %in% c("4", "7"))

ggplot(litter2.2, aes(x = LAI, y = litter, color = obs_period)) +
  geom_point() + geom_smooth(fill = "NA", method = "lm", aes(color = obs_period)) +
  scale_color_manual(values = c("4" = "red", "7" = "purple"),
    labels = c("4" = "16 Feb", "7" = "30 Mar")) +
      labs(x = "LAI", y = "Litter Fuel Mositure (%)", color = "Date",
        title = "Litter Fuel Mositure Slope Decreases in Late Season") + 
   theme_bw()

```

```{r 2.2.2 grass fm plot}

ggplot(LAIxfm_obs, aes(x = LAI, y = grass, color = obs_period)) +
  geom_point() + geom_smooth(fill = "NA", method = "lm", aes(color = obs_period))

```

The woody leaf component of the fuel assemblage is far less relevant than the fine fuels (litter and grass) in determining fire likelihood. Furthermore, the woody leaf data is far more variable due to the wide range of species that were sampled for fuel moistures.

```{r 2.2.2 woody leaf fm plot}

ggplot(LAIxfm_obs, aes(x = LAI, y = woody_leaf, color = obs_period)) +
  geom_point() + geom_smooth(fill = "NA", method = "lm", aes(color = obs_period))

```

In the woody leaf graph, you'll notice far poorer fit than in the other surface fuel graphs. The woody leaf data is far more variable in large part due to the wide variety of species that were sampled throughout the season. When sampling for woody fuel, we would pluck leaves from the nearby woody plants in a ratio that roughly represented their distribution in the quadrant. However, due to differences in species traits, and phenologies, and local water availability, different woody species had quite different leaf moisture at different times of the season. The most relevant trend that we can recognize in the woody leaf data aligns temporally with the mid-season (late February) transition presented by the other fuel types. During the first four sampling periods, woody leaf moisture hardly deviated along the canopy gradient, and exhibited a positive relationship with canopy cover. After the mid-season mark, the relationship flipped to negative, and the slope gradually increased with each sampling period until the end of March. Between the early and late season, open canopy leaf moisture hardly deviated (intercepts were insignificant), but closed canopy leaf moistures dropped from 120% to 80%. While this is not terribly relevant for fire likelihood, it helps to corroborate the surprisingly abrupt shift that we see in the mid-season fuel conditions and it less directly speaks to the functional differences across the open and closed- canopy ecosystems. Towards the end of the season, most of the open-canopy deciduous trees had already shed leaves months earlier and some were beginning to flush new leaves, whereas the evergreen species that had never shed leaves were hanging on to visibly parched, wilted leaves. Since we only selected live leaves off of trees, the highly-deciduous quadrants rarely exhibit a change in leaf moisture as a relatively greater proportion of the open-canopy trees actively drop their leaves at the early signed of drought. As their leaves senesce, they contribute to the litter load, rather than hanging on until wilting.

```{r 2.2.2 10 hr fm plot}

ggplot(LAIxfm_obs, aes(x = LAI, y = ten_hr, color = obs_period)) +
  geom_point() + geom_smooth(fill = "NA", method = "lm", aes(color = obs_period))

```

## Part 2: Fire Modelling

A major focus of this research is fuel availability, with particular attention placed on the variability of surface fuels between open and closed canopy ecosystems and the variability in surface fuels over the dry season. Fuel is available to fire when fuel moisture is sufficiently low and when fuel composition is distributed in a continuous arrangement conducive to fire spread. The interplay of these variables in determining fuel availability creates a heterogenous distribution of flammability throughout the horizontal and vertical composition of the environment. In Southeast Asia, fires occur every year, but the location, size, and intensity of fires is determined as a product of these concurrent factors.

## Q3: 1) How does probability of fire vary with canopy cover? 2) How does this change across the dry season?

"Along with litter, grasses represent the most important combustible material in most tropical ecosystems, especially in the savannas and the tropical grasslands (Stott 2000)"

### 3.1) How does probability of fire vary with canopy cover?

To compare modeled fire likelihood across canopy cover, I will average the 8 LAI observations over the course of the season for each quadrant (for n = 46 LAI means total). I believe this method, rather than using Basal Area or any single given LAI measurement provides the best representation of the changing canopy cover conditions at any fixed point during the fire season. Averaging LAI values for each quadrant across the season will also mitigate deviations in LAI records due to sky conditions at the time of observation (LAI-2200c is sensitive to slight variation in sensor positioning or angle and to sky conditions, which is partially accounted for with the K-records and scattering corrections, but still prone to deviation).

```{r LAI, include = FALSE}
#loading in LAI data
LAI <- read_csv("C:/Users/d/Desktop/UBC 2023/Robinson-Project-MSc/KH_data/LAI/LAI_V1.csv", 
    col_types = cols(date = col_date(format = "%m/%d/%Y"), 
        LAI = col_number()))

#averaging LAI data across all observations for one value per quadrant (n=50)
LAI_avg <- LAI %>%
  group_by(plot_id, quad_id) %>%
  summarise(mean_LAI = mean(LAI, na.rm = TRUE))
```

For each quadrant (n = 46) we will average the fuel moisture contents from the 8 observations throughout the season. I believe this method of averaging all observations rather than using any single fuel moisture observation will provide the best representation of fuel moisture for a given quadrant across the season and will mitigate the effects of deviations in fuel moisture sampling time. Dead fuel moisture content is very sensitive to diurnal fluctuations in microclimate, and maximum daily fuel curing lags behind the sun's rising each day. By averaging fuel moisture across the season, we will reduce the variation attributed to differences in fuel moisture collection time (all measurements were taken after 10:00 am to account for this to some degree, but variation still exists). For BehavePlus input we will use fuel moisture from several fuel categories: live woody, live herbaceous, 100 hour, 10 hour, and 1 hour fuel (for 1 hr we will include litter fuel moistures which are structurally similar to 1 hr sticks).

```{r fuel_moisture pivot_wider, include = FALSE}
fm <- read_csv("C:/Users/d/Desktop/UBC 2023/Robinson-Project-MSc/KH_data/Fuel-Moisture/fm_V3.csv", 
    col_types = cols(date = col_date(format = "%d/%m/%Y"), 
        fuel_moisture = col_number()))

#remove the species column as it gets in the way of pivot_wider:
fm <- fm %>% 
  select(-c(species))

#and now to untidy the fuel_types, so that each is its own column, displaying the fuel moisture data
fm <- fm %>% 
pivot_wider(names_from = fuel_type,
            values_from = fuel_moisture)

#a few of the quadrants had data from multiple grass species (for comparing bamboo vs C4 grass in the same location) that were displayed as a vector after pivoting wider, I will average these data.
fm$grass <- lapply(fm$grass, function(x) mean(x))

#replacing null with NA
fm$woody_leaf[is.na(fm$woody_leaf)] <- "NA"


#converting the columns back to numeric from list, 4 of the columns must be converted to character first and then numeric because they had NULL values. I believe the NULL values came from the pivot_wider operation and appeared for the placeholder data that never had an entry across all observations.

fm$grass <- as.numeric(unlist(fm$grass))
fm$woody_leaf <- as.numeric(unlist(as.character(fm$woody_leaf)))
fm$litter <- as.numeric(unlist(as.character(fm$litter)))
fm$one_hr <- as.numeric(unlist(as.character(fm$one_hr)))
fm$ten_hr <- as.numeric(unlist(as.character(fm$ten_hr)))
fm$hundred_hr <- as.numeric(unlist(as.character(fm$hundred_hr)))

#making sure everything converted properly:
head(fm)

#One more thing, change quad_id: qc to c to match other tables.
fm <- fm %>%
  mutate(quad_id = case_when(quad_id == "qc" ~ "c", TRUE ~ quad_id))

write.csv(fm, "C:/Users/d/Desktop/UBC 2023/Robinson-Project-MSc/KH_data/Fuel-Moisture/fm_V4.csv", row.names=FALSE)
```

```{r fuel_mositure, include = FALSE}
fm_V4 <- read_csv("C:/Users/d/Desktop/UBC 2023/Robinson-Project-MSc/KH_data/Fuel-Moisture/fm_V4.csv", 
    col_types = cols(date = col_date(format = "%m/%d/%Y"), grass = col_number(), woody_leaf = col_number(),litter = col_number(), hundred_hr = col_number(), ten_hr = col_number(), one_hr = col_number()))

#Averaging fm for each fuel class across season for behaveplus input
fm_avg <- fm_V4 %>% 
 group_by(plot_id, quad_id) %>%
  summarise(woody_leaf = mean(woody_leaf, na.rm = TRUE), grass = mean(grass, na.rm = TRUE), litter = mean(litter, na.rm = TRUE), ten_hr = mean(ten_hr, na.rm = TRUE), hundred_hr = mean(hundred_hr, na.rm = TRUE))
```

For comparing fire likelihood across canopy cover, the two biomass observations (early and late season) will also be averaged for each quadrant. Each logger will then serve as the point at which input (response) variables (biomass, fuel moisture, microclimate) and canopy cover (explanatory) variable will be determined for 46 individual sets of models run. We will end up with a scatterplot of 46 fire behavior outputs which we will then use to create a mixed-effects model in R. Quadrants within the same plot will be spatially autocorrelated, so analysis will include random effects for plot type. I anticipate a sigmoidal relationship between canopy cover and fire likelihood, where fire likelihood is relatively similar at canopy covers where grass is unobstructed (0-3 LAI), but experiences a steep decline at the point at which grass growth is restricted (\~3 LAI), and then leveling out again at relatively low fire behavior throughout the closed canopy (from 3-6 LAI).

```{r biomass, include = FALSE}
#load in biomass_V2 data
biomass <- read_csv("C:/Users/d/Desktop/UBC 2023/Robinson-Project-MSc/KH_data/Biomass/biomass_V2.csv", 
     col_types = cols(grass_height = col_number(), litter_depth = col_number(), grass_per = col_number(), wood_per = col_number(), bare_per = col_number(),  litter_per = col_number(), mass_grass = col_number(), mass_liana = col_number(), mass_wood = col_number(), mass_litter = col_number(), seedlings = col_number(), grass_vol = col_number(), grass_bulk = col_number(), litter_vol = col_number(), litter_bulk = col_number(), fine_vol = col_number(), fine_bulk = col_number()))

#there were two biomass observation periods in early and late season and each quadrant consisted of 3 records for a total of n=150 records for each season and n=300 records in total
#we will average across season and quadrants for n=50 records (4 of which are NA because no data for the missing sensors)

biomass_avg <- biomass %>%
  group_by(plot_id, quad_id) %>%
  summarise(grass_mass = mean(mass_grass), litter_mass = mean(mass_litter), wood_mass = mean(mass_wood), woody_mass = mean(mass_liana + seedlings*10), grass_height = mean(grass_height), litter_depth = mean(litter_depth))

#the biomass input in the model requires mass per unit area so we will determine kg/m^2 for each fuel type. The quadrat was .25m^2.

biomass_load <- biomass_avg %>% 
  group_by(plot_id) %>% 
  mutate_at(vars(3:6), ~ . * .004)
 
```

One more thing with the biomass data, using the shading column to determine "fuel shading from the sun" category in Behaveplus.

```{r shading, include = FALSE}
shaded <- biomass %>% 
  group_by(quad_id, plot_id) %>% 
  filter(shading == 'Y') %>%
  count()

unshaded <- biomass %>% 
  group_by(quad_id, plot_id) %>% 
  filter(shading == 'N') %>% 
  count()

shade_join <- left_join(shaded, unshaded, by=c("plot_id", "quad_id"))

shade_pct <- shade_join %>% 
  transmute(shade = n.x/(n.x + n.y)) 

shade_pct$shade <- shade_pct$shade %>% 
  replace_na(1)

shade_pct <- shade_pct %>% 
  summarise(shade = shade*100)

```

Additionally, we will determine an average windspeed for each plot across the season from the kestrel data. The kestrels were in 6 out of the 10 plots representing the full spectrum of tree density, from the most open canopy (DDF6) to the most closed canopy (EVG3). We determine windspeed input for Q3.1 by averaging the daily maximum values of windspeed for each kestrel across the season. The kestrels did not have swivels to track the wind, and we found that this method of averaging maximums provided for open-canopy values closest to that of the weather station data. We will populate the plots for which there is no wind speed data by fitting a regression line for LAI and wind speed. Its not bullet-proof, and is based off of six data points, but it is significant and looks reasonably fit, despite how few data there is.

```{r kestrel wind setup, include=FALSE}
#daily max windspeed
kestrel_V1 <- read_csv("C:/Users/d/Desktop/UBC 2023/Robinson-Project-MSc/KH_data/Kestrel/kestrel_V1.csv", 
    col_types = cols(temp = col_number(), 
        rh = col_number(), wind_speed = col_number()))

kestrel_wind <- kestrel_V1 %>% 
  group_by(month, day, plot_id) %>% 
  summarize(wind_speed = max(wind_speed))

kestrel_wind <- kestrel_wind %>% 
  mutate(season = case_when(
    month %in% c("1","2") ~ 'early',
    month %in% c("3","4") ~ 'late'
  ))

#summary table for wind speed by plot (n=6)
kestrel_wind %>% 
  group_by(plot_id) %>% 
  summarize(wind_speed = mean(wind_speed))

#creating model for wind speed from relationship with LAI to fill in values for 4 missing plots
#made quick table relating LAI and wind_speed values from above
windxLAI <- read_csv("C:/Users/d/Desktop/UBC 2023/Robinson-Project-MSc/KH_data/Kestrel/windxLAI.csv", 
    col_types = cols(LAI = col_number(), 
        BA = col_number(), wind_speed = col_number()))
View(windxLAI)

lm <- lm(wind_speed ~ LAI, data = windxLAI)
summary(lm)

ggplot(windxLAI, aes(x = LAI, y = wind_speed)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  labs(x = "LAI", y = "Wind Speed") +
  ggtitle("Wind Speed vs LAI regression")

#using lm to predict windspeeds for 4 no-kestrel plots
missing_rows <- is.na(windxLAI$wind_speed)
new_data <- windxLAI[missing_rows, ]
new_data$wind_speed <- predict(lm,newdata= new_data)
windxLAI[missing_rows, ] <- new_data

```

```{r wind speed, include = FALSE}
(windxLAI)
```

Now its time to bring in the TOMST temperature data for each quadrant to populate the input for the PIG. TOMST were auto-logging temperature from late January to April. For this analysis we will average daily temp values between 10:00 and 18:00, as these are the primary hours during which fuel moistures are significantly low for fire ignition, and are the hours during which we recorded fuel moistures.

```{r TOMST temperature, include = FALSE}
TOMST_V1 <- read_csv("C:/Users/d/Desktop/UBC 2023/Robinson-Project-MSc/KH_data/TOMST/TOMST_V1.csv", 
    col_types = cols(date = col_date(format = "%Y.%m.%d"), 
        date_time = col_datetime(format = "%Y.%m.%d %H:%M"), 
        air_temp = col_number(), soil_moisture = col_number()))

#average air_temp values for each quadrant across whole season for 11:00-18:00
#first filter data between midday times
TOMST_filter <- TOMST_V1 %>% 
filter(hour(date_time) > 10, hour(date_time) < 18) 

#average data
TOMST_V2 <- TOMST_filter %>% 
group_by(plot_id, quad_id) %>% 
  summarize(air_temp = mean(air_temp), soil_moist = mean(soil_moisture))


```

Lastly, we will populate the input for surface area to volume ratio (SA:V) and moisture of extinction for each plot by identifying which of the 40 standard fuel models (Scott and Burgan 2005) best fit our field observations.

```{r fuel models, include=FALSE}
#we will find the average fuel load and fuel depth per plot and convert to tonnes/acre (1 to 10) to help gauge which of Scott and Burgan's 40 models is the best fuel model to pair each plot with.

biomass_load %>%
  group_by(plot_id) %>%
  summarise(across(everything(), mean, na.rm = TRUE)) %>% 
  mutate_at(vars(3:6), ~ . * 10)

```

**The plots are aligned with these models:**

-   TL6/186 - Moderate load, less compact. Spread rate moderate; flame length low. PRIMARY CARRIER OF THE FIRE IS DEAD AND DOWN WOODY FUEL (LITTER) BENEATH A FOREST CANOPY. Mositure of extinction is 25 percent: **DDF2, EVG1, EVG2, EVG3, EVG4, EVG5**

-   TU3/163 - Fuel bed is moderate litter load with grass and shrub components. Humid climate. Spread rate high; flame length moderate. PRIMARY CARRIER OF THE FIRE IS GRASS OR SHRUBS MIXED WITH LITTER FROM FOREST CANOPY (TIMBER-UNDERSTORY). Extinction moisture is 30 percent: **DDF3**

-   GR5/105 - Dense, coarse grass, average depth about 1 to 2 feet (0.3 to 0.6 meters). Spread rate very high; flame length high. Subhumid to humid climate (rainfall adequate in all seasons). Extinction moisture content 40 percent. Spread rate high; flame length moderate.PRIMARY CARRIER GRASS: **DDF4, DDF5, DDF6**

#### Cumulative Behaveplus table:

Merging all of the above data into one table for behave plus input

```{r behaveplus table setup, inlcude = FALSE}
#merging all of the relevant input variables, detailed below:
join1 <- left_join(LAI_avg, biomass_load, by=c("plot_id", "quad_id"))

join2 <- left_join(join1, fm_avg, by=c("plot_id", "quad_id"))

join3 <- join2 %>% 
 left_join(select(windxLAI, plot_id, wind_speed), by="plot_id")

join4 <- left_join(join3, shade_pct, by=c("plot_id", "quad_id"))

behave_tbl <- left_join(join4, TOMST_V2, by=c("plot_id", "quad_id"))

```

#### Pluggin values into Behaveplus:

There's probably a faster way to do this, some R package or another, but I'm going to plug all 46 inputs into the Behaveplus software, and then create a new table by hand for the outputs:

**Breakdown of input values (SURFACE fire spread model and Probability of Ignition (PIG) model):**

-   Fuel Model Number

-   Fuel Model Code: Plot fuel characteristics compared with Burgan's 40 fuel models to determine best fit.

-   1-hr fuel load (kg/m2): Input from litter load

-   10-hr fuel load (kg/m2): Input from half of wood load

-   100-hr fuel load (kg/m2): Input from half of wood load

-   Live Herbaceous Fuel Load (kg/m2): Input from grass load

-   Live Woody Fuel Load (kg/m2): Input from woody load

-   1-h, Live Herbaceous, and Live Woody SA/V (m2/m3): Input from model constants for each plot (see above step)

-   Fuel Bed Depth (m): Input from grass height when grass is relatively continuous enough to sustain fire (>0.1kg/m2), otherwise determined from litter depth

-   Dead fuel moisture of extinction (%): Similar to SA/V, auto-populated by fuel code

-   Dead Fuel and Live Fuel Heat Content (kJ/kg): Held constant = 18622

-   Fuel Moisture (%): All fuel moisture input come from fuel moisture averages described above

-   Midflame Windspeed: Max daily kestrel values averaged over season

-   Slope Steepness (%): Held constant at 0, very little slope involved in area

-   Temperature (C): Input from TOMST values averaged between 10:00 and 18:00 for all quadrants

-   Fuel Shading From Sun (%): Values determined from biomass data of visual estimations of canopy cover as Bernoulli distributed (they just yes or no), and then averaged for each quadrant

**Output**

-   Surface Fire Rate of Spread (ROS) (m/min):

-   Surface Fireline Intensity (kW/m):

-   Surface Fire Flame Length (m):

-   Probability of Ignition (PIG) (%):

**TABLE OF RESULTS FOR BEHAVEPLUS OUTPUT**

```{r behave output table, include = FALSE}
behave_output <- read_csv("C:/Users/d/Desktop/UBC 2023/Robinson-Project-MSc/KH_data/Behaveplus/behave_3.1_output.csv", 
    col_types = cols(mean_LAI = col_number(), 
        fuel_model = col_integer(), litter_load = col_number(), 
        hr10_load = col_number(), hr100_load = col_number(), 
        herb_load = col_number(), woody_load = col_number(), 
        grass_height = col_number(), litter_depth = col_number(), 
        litter_fm = col_number(), hr10_fm = col_number(), 
        hr100_fm = col_number(), grass_fm = col_number(), 
        woody_fm = col_number(), wind_speed = col_number(), 
        air_temp = col_number(), shade = col_number(), 
        soil_moist = col_number(), ROS = col_number(), 
        intensity = col_number(), flame_length = col_number(), 
        PIG = col_integer()))
```

```{r PIG analysis, include}
#PIG as product of LAI
lm3.1.1 <- lm(PIG ~ mean_LAI, data = behave_output)
summary(lm3.1.1)

#residuals look passable
plot(lm3.1.1, which = 1)
#QQ quite good
plot(lm3.1.1, which = 2)

#We know none of this will be independent because of plot. But I'm unsure on how much that matters for every question and if that warrants mler every time? Just sticking with lm for now.

#probability of ignition as a product of LAI looking like a linear regression dream

pred <- ggpredict(lm3.1.1, terms = c("mean_LAI"))  # this gives overall predictions for the model

# Plot the predictions 

(ggplot(pred) + 
   geom_line(aes(x = x, y = predicted), color = "red") +          # slope
   geom_ribbon(aes(x = x, ymin = predicted - std.error, ymax = predicted + std.error), 
               fill = NA, alpha = 0.5) +  # error band
   geom_point(data = behave_output,                # adding the raw data
              aes(x = mean_LAI, y = PIG)) + 
   labs(x = "LAI", y = "Probability of Ignition (%)", 
        title = "Probability of Ignition (PIG) Decreases Linearly Across Canopy Gradient") + 
   theme_bw()
)

```

Compared this slope to the inverse of avg litter fuel moisture across LAI, litter moisture

```{r Flame Length Analysis}
ggplot(behave_output, aes(x = mean_LAI, y = flame_length)) +
  geom_point() + stat_smooth(color = "red", fill = NA) +
    labs(x = "LAI", y = "Flame Length (m)", 
        title = "Flame Length Across Canopy Gradient") +
  ylim(0, 5) +
   theme_bw()
```

```{r ROS plot}
ggplot(behave_output, aes(x = mean_LAI, y = ROS)) +
  geom_point() + stat_smooth(color = "red", fill = "NA")+
    labs(x = "LAI", y = "ROS", 
        title = "Rate of Spread Across Canopy Gradient") +
 theme_bw()+
      ylim(0, 17)
```

### 3.2) How does predicted fire behavior across the gradient of canopy cover change from the early to the late dry season?

Since I messed up the early season fuel moisture by not collecting litter, for the cross season analysis I will use the first viable fuel moisture observations, which are from observation 4 (Feb 16), which is 2-3 weeks after the January biomass sampling, but still before the big LAI and temperature dip. Its not perfect, but will still allow me to compare fuels that are 6 weeks apart.

I'm still going to average LAI around the obs to account for any missing values or bad recordings. And since early season biomass is in late Jan and the fuel moisture is in mid Feb, including the LAI in the range of those two feels like a good move.

```{r behave3.2 LAI, include = FALSE}
#loading in LAI data
LAI <- read_csv("C:/Users/d/Desktop/UBC 2023/Robinson-Project-MSc/KH_data/LAI/LAI_V1.csv", 
    col_types = cols(date = col_date(format = "%m/%d/%Y"), 
        obs_period = col_integer(), LAI = col_double(), 
        month = col_integer()))

#pulling LAI data from early ob: 2-4  and late ob: 6-8
LAI_3.2_early <- LAI %>% 
  filter(obs_period %in% c(2,3,4)) %>% 
  group_by(plot_id, quad_id, season) %>% 
  summarize(mean_LAI = mean(LAI, na.rm = TRUE))

LAI_3.2_late <- LAI %>% 
  filter(obs_period %in% c(6,7,8)) %>% 
  group_by(plot_id, quad_id, season) %>% 
  summarize(mean_LAI = mean(LAI, na.rm = TRUE))

#stack the tables for early and late together
LAI_3.2<- dplyr::union(LAI_3.2_early, LAI_3.2_late)
```

Fuel moisture is not averaged, but taken from the closest viable single obs to the biomass obs.

```{r behave3.2 fuel_mositure, include = FALSE}
fm_V5 <- read_csv("C:/Users/d/Desktop/UBC 2023/Robinson-Project-MSc/KH_data/Fuel-Moisture/fm_V5.csv", 
    col_types = cols(date = col_date(format = "%m/%d/%Y"), grass = col_number(), woody_leaf = col_number(),litter = col_number(), hundred_hr = col_number(), ten_hr = col_number(), one_hr = col_number()))

#Averaging fm for each fuel class for obs period 4 and 7
fm_3.2 <- fm_V5 %>% 
  filter(obs_period %in% c(4,7)) %>% 
 group_by(plot_id, quad_id, obs_period) %>%
  summarise(woody_leaf = mean(woody_leaf, na.rm = TRUE), grass = mean(grass, na.rm = TRUE), litter = mean(litter, na.rm = TRUE), ten_hr = mean(ten_hr, na.rm = TRUE), hundred_hr = mean(hundred_hr, na.rm = TRUE))

fm_3.2 <- fm_3.2 %>% 
  mutate(season = case_when(
    obs_period == 4 ~ "early",
    obs_period == 7 ~ "late"
  ))
```

Biomass observations separated by early and late season.

```{r behave3.2 biomass, include = FALSE}
biomass <- read_csv("C:/Users/d/Desktop/UBC 2023/Robinson-Project-MSc/KH_data/Biomass/biomass_V2.csv", 
     col_types = cols(grass_height = col_number(), litter_depth = col_number(), grass_per = col_number(), wood_per = col_number(), bare_per = col_number(),  litter_per = col_number(), mass_grass = col_number(), mass_liana = col_number(), mass_wood = col_number(), mass_litter = col_number(), seedlings = col_number(), grass_vol = col_number(), grass_bulk = col_number(), litter_vol = col_number(), litter_bulk = col_number(), fine_vol = col_number(), fine_bulk = col_number()))

#there were two biomass observation periods in early and late season and each quadrant consisted of 3 records for a total of n=150 records for each season and n=300 records in total
#we will average across quadrants and keep season separate for n=100 records (8 of which are NA because no data for the missing sensors)

biomass_3.2 <- biomass %>%
  group_by(plot_id, quad_id, season) %>%
  summarise(grass_mass = mean(mass_grass), litter_mass = mean(mass_litter), wood_mass = mean(mass_wood), woody_mass = mean(mass_liana + seedlings*10), grass_height = mean(grass_height), litter_depth = mean(litter_depth))

#the biomass input in the model requires mass per unit area so we will determine kg/m^2 for each fuel type. The quadrat was .25m^2.

biomass_3.2 <- biomass_3.2 %>% 
  group_by(plot_id) %>% 
  mutate_at(vars(4:7), ~ . * .004)
```

Using the exact same shading from 3.1 (this is an average across the whole season, but honestly I'm afraid to change it because this measurement was too subjective and my early season measurements and Phem's late season measurements may not jive)

```{r behave 3.2 shading, include = FALSE}
shaded <- biomass %>% 
  group_by(quad_id, plot_id) %>% 
  filter(shading == 'Y') %>%
  count()

unshaded <- biomass %>% 
  group_by(quad_id, plot_id) %>% 
  filter(shading == 'N') %>% 
  count()

shade_join <- left_join(shaded, unshaded, by=c("plot_id", "quad_id"))

shade_pct <- shade_join %>% 
  transmute(shade = n.x/(n.x + n.y)) 

shade_pct$shade <- shade_pct$shade %>% 
  replace_na(1)

shade_pct <- shade_pct %>% 
  summarise(shade = shade*100)
```

Re-did this convoluted wind estimation for early and late season, notes detailed in the code.

```{r behave 3.2 wind, message=FALSE, warning=FALSE, include=FALSE}
kestrel_V1 <- read_csv("C:/Users/d/Desktop/UBC 2023/Robinson-Project-MSc/KH_data/Kestrel/kestrel_V1.csv", 
    col_types = cols(temp = col_number(), 
        rh = col_number(), wind_speed = col_number()))

kestrel_wind <- kestrel_V1 %>% 
  group_by(month, day, plot_id) %>% 
  summarize(wind_speed = max(wind_speed))

kestrel_wind <- kestrel_wind %>% 
  mutate(season = case_when(
    month %in% c("1","2") ~ 'early',
    month %in% c("3","4") ~ 'late'
  ))

#summary table for wind speed by plot (n=6)
kestrel_wind %>% 
  group_by(plot_id, season) %>% 
  summarize(wind_speed = mean(wind_speed))

LAI_3.2 %>% 
  group_by(plot_id, season) %>% 
  summarize(LAI = mean(mean_LAI))

#creating model for wind speed from relationship with LAI to fill in values for 4 missing plots
#made quick table relating LAI and wind_speed values from above
windxLAI_3.2 <- read_csv("C:/Users/d/Desktop/UBC 2023/Robinson-Project-MSc/KH_data/Kestrel/windxLAI_3.2.csv", 
    col_types = cols(LAI = col_number(), 
   wind_speed = col_number()))


lm <- lm(wind_speed ~ LAI, data = windxLAI_3.2)
summary(lm)

ggplot(windxLAI_3.2, aes(x = LAI, y = wind_speed)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  labs(x = "LAI", y = "Wind Speed") +
  ggtitle("Wind Speed vs LAI regression")

#using lm to predict windspeeds for 4 no-kestrel plots
missing_rows <- is.na(windxLAI_3.2$wind_speed)
new_data <- windxLAI_3.2[missing_rows, ]
new_data$wind_speed <- predict(lm,newdata= new_data)
windxLAI_3.2[missing_rows, ] <- new_data

```

Temperature taken from the same day as fuel moisture, as fuel moisture is the variable most linked microclimate (and the most mercurial/prone to daily flux).

```{r behave 3.2 TOMST temperature, include = FALSE}
TOMST_V1 <- read_csv("C:/Users/d/Desktop/UBC 2023/Robinson-Project-MSc/KH_data/TOMST/TOMST_V1.csv", 
    col_types = cols(date = col_date(format = "%Y.%m.%d"), 
        date_time = col_datetime(format = "%Y.%m.%d %H:%M"), 
        air_temp = col_number(), soil_moisture = col_number()))

#average air_temp values for each quadrant for the days that match the fuel moisture
#first filter data between midday times
TOMST_filter <- TOMST_V1 %>% 
filter(hour(date_time) > 10, hour(date_time) < 18) 

TOMST_3.2 <- TOMST_filter %>% 
  filter(date %in% c("2023-02-16", "2023-03-29", "2023-03-30"))

TOMST_3.2 <- TOMST_3.2 %>%
  mutate(season = case_when(
    date %in% c('2023-02-16') ~ 'early',
    date %in% c('2023-03-29', '2023-03-30') ~ 'late'
  ))

TOMST_3.2 <- TOMST_3.2 %>% 
group_by(plot_id, quad_id, season) %>% 
  summarize(air_temp = mean(air_temp), soil_moist = mean(soil_moisture))
  
```

Setup same as 3.1. Table written to data folder.

```{r behave3.2 table setup, inlcude = FALSE}
#merging all of the relevant input variables, detailed below:
join1 <- left_join(LAI_3.2, biomass_3.2, by=c("plot_id", "quad_id", "season"))

join2 <- left_join(join1, fm_3.2, by=c("plot_id", "quad_id", "season"))

join3 <- left_join(join2, windxLAI_3.2, by= c("plot_id", "season"))

join4 <- left_join(join3, shade_pct, by=c("plot_id", "quad_id"))

behave_tbl_3.2 <- left_join(join4, TOMST_3.2, by=c("plot_id", "quad_id", "season"))

```

**Plugging early and late season values into Behave Plus** will look the same as in 3.1.

#### Behave Output: Table of Results

```{r behave3.2 output table, include = FALSE}
behave_output3.2 <- read_csv("C:/Users/d/Desktop/UBC 2023/Robinson-Project-MSc/KH_data/Behaveplus/behave_3.2_V2.csv", 
    col_types = cols(mean_LAI = col_number(), 
        fuel_model = col_integer(), litter_load = col_number(), 
        hr10_load = col_number(), hr100_load = col_number(), 
        herb_load = col_number(), woody_load = col_number(), 
        grass_height = col_number(), litter_depth = col_number(), 
        litter_fm = col_number(), hr10_fm = col_number(), 
        hr100_fm = col_number(), grass_fm = col_number(), 
        woody_fm = col_number(), wind_speed = col_number(), 
        air_temp = col_number(), shade = col_number(), 
        soil_moist = col_number(), ROS = col_number(), 
        intensity = col_number(), flame_length = col_number(), 
        PIG = col_integer()))
```

For the Probability of Ignition and all behave output variables by season we will be using GAMs, the nitty gritty for why we chose which one and the logic are in the GAMMs.R file.
```{r 3.2 PIG analysis}
#convert season to a factor
behave_output3.2$season <- factor(behave_output3.2$season)

#drop NAs
behave_output3.2 <- behave_output3.2 %>% drop_na(PIG)


#GAM with interaction
factor_interact <- gam(PIG ~ season + s(mean_LAI, by = season),
                         data = behave_output3.2, method = "REML")

summary(factor_interact)

#PLOT
PIG_data <- expand.grid(mean_LAI = seq(min(behave_output3.2$mean_LAI), max(behave_output3.2$mean_LAI), length = 100),
                        season = unique(behave_output3.2$season))

# Make predictions using the GAM model
PIG_data$predicted <- predict(factor_interact, newdata = PIG_data, type = "response")
```

```{r 3.2 PIG Plot}
# Create a plot using predicitons from GAM
ggplot(PIG_data, aes(x = mean_LAI, y = predicted, color = season)) +
  geom_line() +
  geom_point(data = behave_output3.2, aes(x = mean_LAI, y = PIG, color = season), alpha = 0.5) +
  labs(title = "Relationship between canopy cover and PIG by season",
       x = "LAI",
       y = "Probability of Ignition (PIG)") +
  theme_minimal()

```

```{r 3.2 ROS data analysis}

gam_model <- gam(ROS ~ season + s(mean_LAI, by = season, k=5),
                         data = behave_output3.2, method = "REML")


summary(gam_model)
k.check(gam_model)
gam.check(gam_model)

#Trying a different distribution

gam_model_tw <- gam(ROS ~ season + s(mean_LAI, by = season, k=5),
                    family = tw(link = "log"), data = behave_output3.2, method = "REML")
  
summary(gam_model_tw)
k.check(gam_model_tw)
gam.check(gam_model_tw)

#They look much better with a tweedie dist

```

``` {r ROS plot}
#PLOT
gam_data <- expand.grid(mean_LAI = seq(min(behave_output3.2$mean_LAI), max(behave_output3.2$mean_LAI), length = 100),
                        season = unique(behave_output3.2$season))

# Make predictions using the GAM model
gam_data$predicted <- predict(gam_model_tw, newdata = gam_data, type = "response")


behave_output3.2$plot_id <- factor(behave_output3.2$plot_id)
# Create a plot using predicitons from GAM
ggplot(gam_data, aes(x = mean_LAI, y = predicted, color = season)) +
  geom_line() +
  geom_point(data = behave_output3.2, aes(x = mean_LAI, y = ROS, color = season), alpha = 0.5) +
  labs(title = "Relationship between canopy cover and ROS by season",
       x = "LAI",
       y = "Rate of Spread (m/min)") +
  theme_minimal()

```

Now, we're going to add a mixed effect for plot_id and compare
```{r ROS GAMM}
# Assuming 'response' is your continuous response variable,----
# 'predictor' is your continuous predictor variable,
# 'season' is your factor variable with two levels (early and late),
# and 'plot_id' is your factor variable with 10 levels.

#first, make plot_id a factor
behave_output3.2$plot_id <- factor(behave_output3.2$plot_id)

# Creating a GAM model with a random intercept for 'plot_id'
gamm_model<- gam(ROS ~ season + s(mean_LAI, by = season) + s(plot_id, bs = "re"),
                       data = behave_output3.2, method = "REML")

summary(gamm_model)
k.check(gamm_model)
gam.check(gamm_model)

#trying different distributions to make assumptions look better?

gamm_model_tw<- gam(ROS ~ season + s(mean_LAI, by = season) + s(plot_id, bs = "re"),
                family = tw(link = "log"), data = behave_output3.2, method = "REML")

summary(gamm_model_tw)
  k.check(gamm_model_tw)
gam.check(gamm_model_tw)

#Holy shit they look so much better
#Comparing the GAM and the GAMM
AIC(gamm_model, gamm_model_tw)
```

```{r ROS GAMM plot}

#PLOT
gamm_data <- expand.grid(mean_LAI = seq(min(behave_output3.2$mean_LAI), max(behave_output3.2$mean_LAI), length = 100),
                        season = unique(behave_output3.2$season),
                        plot_id = unique(behave_output3.2$plot_id))

# Make predictions using the GAM model
gamm_data$predicted <- predict(gamm_model_tw, newdata = gamm_data, type = "response")


# Create a plot using ggplot2
ggplot(gamm_data, aes(x = mean_LAI, y = predicted, color = season)) +
  geom_line()+
  geom_point(data = behave_output3.2, aes(x = mean_LAI, y = ROS, color = season), alpha = 0.5) +
  labs(title = "Seasonal Difference in ROS and LAI (GAMM)",
       x = "LAI",
       y = "ROS") +
  theme_minimal()

```

```{r random intercepts}
# Plot the summed effect of x0 (without random effects)
plot_smooth(gamm_model_tw, view = "mean_LAI", rm.ranef = FALSE, cond = list(plot_id = "ddf2"),
            main = "... + s(plot_id)", col = "orange", ylim = c(-10,5))
plot_smooth(gamm_model_tw, view = "mean_LAI", rm.ranef = FALSE, cond = list(plot_id = "ddf3"),
            add = TRUE, col = "red")
plot_smooth(gamm_model_tw, view = "mean_LAI", rm.ranef = FALSE, cond = list(plot_id = "ddf4"),
            add = TRUE, col = "purple")
plot_smooth(gamm_model_tw, view = "mean_LAI", rm.ranef = FALSE, cond = list(plot_id = "ddf5"),
            add = TRUE, col = "turquoise")
plot_smooth(gamm_model_tw, view = "mean_LAI", rm.ranef = FALSE, cond = list(plot_id = "ddf6"),
            add = TRUE, col = "green")
plot_smooth(gamm_model_tw, view = "mean_LAI", rm.ranef = FALSE, cond = list(plot_id = "evg1"),
            add = TRUE, col = "black")
plot_smooth(gamm_model_tw, view = "mean_LAI", rm.ranef = FALSE, cond = list(plot_id = "evg2"),
            add = TRUE, col = "magenta")
plot_smooth(gamm_model_tw, view = "mean_LAI", rm.ranef = FALSE, cond = list(plot_id = "evg3"),
            add = TRUE, col = "blue")
plot_smooth(gamm_model_tw, view = "mean_LAI", rm.ranef = FALSE, cond = list(plot_id = "evg4"),
            add = TRUE, col = "forestgreen")
plot_smooth(gamm_model_tw, view = "mean_LAI", rm.ranef = FALSE, cond = list(plot_id = "evg5"),
            add = TRUE, col = "yellow")

```


Zooming in on the closed canopy grants insight into the seasonal component in determining fire spread. Experimental burns have shown that a low threshold for ROS of .198-.252 m/min is necessary to sustain fire (Marsden-Smedley 2001; Fernandes 2008). Of course this exact figure will vary by site, according to microclimate and fuel composition, but I feel more comfortable comparing to a benchmark like this ROS threshold, than I would with other ecological thresholds, because of the relatively uniform flammability qualities of dead fuel (ref). 

Now we will explore this further, looking at how many

```{r 3.2 Reaction Intensity}


```

#### Were our temperature ranges too broad/ variation in fuel sampling times?

After noticing that the air temperatures yielded from the original 1100 to 1700 time range were quite a bit lower than the daily maxes (which were around more like 1700-1900), we looked at how the behave plus might change when input with daily highs for temp, it seems to have only changed the PIG by a couple of percent, so all should be well, but worth mentioning in the analysis.

This also means that the differences in fuel moisture are the primary determinant of microclimate variability, since RH and Temp are not taken into consideration, whcih makes sense. But also very important to mention that deviations in our sampling times (which were excluded to 11:00 - sunset) almost certainly result in underestimations of peak fire danger for the day (particularly since only one fuel moisture sampling observation (4 or 7) was used in cross seasonal behaveplus analysis.


##Q4: Relative contributions of model inputs (fire parameters) in determining modelled fire likelihood:

Similarly to Hoffman 2012, I will average each Behaveplus inputs across all 46 runs, per season (we will do this twice, 1 average per season), then change one set of parameters at a time to represent open canopy conditions (average of DDF3 - DDF6) or closed canopy conditions (average of EVG1-5). I am omitting DDF2 for now because it is actually mixed deciduous (according to rangers and aligns with Tani 2007). 



