---
title: 'Fuel variability across a Cambodian fire season: Data Analysis'
author: "Daniel Robinson"
date: "2024-03-07"
output:
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r packages, include=FALSE}
library(mgcv)
library(tidyverse)
library(readr)
library(ggplot2)
library(lme4)
library(nlme)
library(ggeffects)
library(vtable)
library(DHARMa)
library(segmented)
library(emmeans)
```

## Introduction

The aim of this research is to explore the heterogeneity of fire recruitment function in the Dipterocarp mosaic: We conducted field observations across the dry season to assess the horizontal distribution of fuel structure and microclimate across a range of canopy cover, from open to closed, to better understand how Cambodia's mosaic is shaped by fire.

This Chapter will be divided into two parts: **Part 1: field observations** and **Part 2: fire modelling**.

**Part 1** will focus on describing the variability in fuel distribution and fuel microclimate across a canopy gradient and across the dry season. We will explore how the surface conditions of open and closed canopy states differ and how this relationship changes in the presence of prolonged seasonal drought, changing fuel loads, increased temperatures that accompany the transition from early to late dry season. We will discuss our study system in the context of alternate stable states, and compare the mosaic dynamics of our system with that of mosaics in other studies throughout the tropics. We will direct our focus by approaching these questions:

*Q1: 1) How does surface fuel composition and structure vary with canopy cover? And how does this relationship change throughout the dry season?*

In approaching this question we will pay particularly close attention to the presence/absence of a sharp canopy cover threshold for grass load (which in past studies has been cited as the primary fuel variable in driving mosaic fire feedback) and seasonal difference in litter load, which will likely play the largest role in altering early to late season fuel structure via bulk density and total fuel load (grass does not change much over the course of a dry season, but litter will accumulate throughout).

*Q2: 1) How does surface microclimate vary with canopy cover? And how does this relationship change throughout the dry season?*

**Part 2** utilizes fire modelling to better understand the variable role of fire recruitment across the mosaic. Understanding fire likelihood and severity is complicated by interacting factors and nonlinear relationships among the various determinants of fire. In an effort to provide some additional clarity and to tease out the shifting relationships between composition and fuel moisture and microclimate across the dry season, we will be using the fire model Behaveplus6 to evaluate predicted fire effects in the absence of physical fire data by asking:

*Q3: 1) How does probability of fire vary with canopy cover? 2) How does this change across the dry season?*

*Q4: 1) Is fire likelihood more limited by fuel or microclimate? 2) Does this relative relationship change throughout the dry season?*

## Analysis

### The canopy gradient

In mesic savannas, woody cover and the abundance, continuity, and composition of grass are correlated. Generally speaking, as tree cover increases, grass cover decreases. This relationship is the result of several above and below ground interactions, and at any given area, the presence or absence of grass may be moderated by a number of factors, such as competition for rooting space and nutrients between woody and herbaceous species, water availability, etc. But within the forest-savanna mosaics of the tropics, it is established that light availability at the ground level -- largely moderated by canopy cover -- is critical in determining the distribution of grasses.

Talk a bit about C4 and why they require more light than their counterparts: Grasses and especially C4 love light

This antogonistic relationship between grasses and trees gives rise to the mosaics that exist throughout the seasonal tropics. Fires are common and frequent in savanna regions globally, and fire is critical (particularly in mesic savanna) to the maintenance of a grassy state, because fire reduces woody cover and ultimately selects for "savanna" tree species via demographic bottlenecks (Nguyen 2019). 

The vertical and horizontal distributions of fuel amount and fuel type is important in determining fire regimes. The savanna fire regime is the most active fire system on Earth. Many savannas have fire return intervals as frequent as once per year, which is largely attributed to the abundant grassy communities that define savanna systems. Within savanna-forest mosaics, fires tend to be restricted to the fuels at the ground level (few canopy fires or torching - because the phenology and architecture of tropical canopies is not conducive to carrying fire). The surface fuel bed is composed of multiple classes of fuels, and while large fuels (100 and 1000 hr logs) may be an important consideration for fire intensity and fire holdover (longevity), almost all considerations of fire ignition and spread are dependent on the distribution of fine fuels (litter and grass). I mention all of this to explain why we will now, 1) focus our attentions and efforts on surface fuels, and primarily on fine fuels (grass and litter), and 2) examine the distribution of these fuels in relation to canopy cover.

BUT WHY DOES THIS MATTER AT ALL??

Because, in a system where fire is proposed to play a hefty role in moderating the distribution between grassy and treed communities, we need to understand how fuel dynamics are spatially (across the canopy gradient) and temporally (across the fire season) distributed to comprehend how *rigid* or stable these boundaries are.

### Leaf Area Index (LAI)

*Canopy cover* is the driver we focus on throughout this analysis. We will evaluate the responses of several fuel variables in relation to our predictor, canopy cover, to parse out the spatial and temporal variability and changes in fuel availability in our system.

Analyses that evaluate tree-grass interactions often focus on the whole tree or the composition/distribution of trees in relation to grass. In this study, our metric for tree cover instead focuses on the canopy as determined via LAI measurements from a LICOR 2200c canopy analyzer. Our aim was to assess how tree cover affects surface fuel as a result of light exclusion, therefore LAI rather than a stand density metric like basal area was more suited to our analysis. LAI allows for the indirect accounting of variation in leaf traits & species composition that is typically lost to error in a basal area analysis . *with regards to light exclusion, basal area assumes uniformity between dbh and canopy architecture which is never the case as different species and different site conditions give rise to varying canopy architectures. Furthermore, as pointed out by several papers (Hoffman, Charles-Dominique) specific leaf area (SLAs) and branch mass architectures (BMAs) may be important functional traits that contrast between savanna-oriented vs forest-oriented species as adaptations for increased light penetration (savanna species) or increased light exclusion (forest species). Under this assertion, a stand of savanna trees at a given basal area would provide less shade than a stand of forest trees of the same basal area.

Evaluating LAI also provides us with the opportunity to roughly assess phenological differences between plots and forest types, which is critical in determining seasonal dynamics of fuel distribution (namely through litter accumulation) and fuel microclimate (namely via temperature and moisture buffering).

Past studies in this region (Very few but largely based on the work of Williams 2008 and more informally from Stott's various papers), suggest a high degree of variability in shedding and flushing, with delay in the timing and a decrease in the magnitude of leaf fall among the evergreen:

**How did LAI change by plot and by plot type across the season?**

```{r LAI across the season}
#loading in LAI data
LAI <- read_csv("C:/Users/d/Desktop/UBC 2023/Robinson-Project-MSc/KH_data/LAI/LAI_V1.csv", 
    col_types = cols(date = col_date(format = "%m/%d/%Y"), 
        LAI = col_number()))

#make season a factor
LAI$season <- factor(LAI$season)
#make plot_id a factor
LAI$plot_id <- factor(LAI$plot_id)
#make plot_type a factor
LAI$plot_type <- factor(LAI$plot_type)

#average all quads for each plot and each observation period
LAI_plots <- LAI %>% 
  group_by(plot_id, obs_period, plot_type, date) %>% 
  summarize(LAI_plot = mean(LAI, na.rm = TRUE))

```

**Canopy cover change by plot across the season**

```{r LAI across the season PLOT}
#we will filter out obs period 5 because records are clearly sketchy from that day due to several bad readings:
LAI_plots <- LAI_plots %>%
  filter(!obs_period == "5", !obs_period == "3")


ggplot(data = LAI_plots, aes(x = date, y = LAI_plot, color = plot_type)) +
  geom_point(alpha = .5, size = .3) + 
  geom_line(aes(group = plot_id),size = .1) +
  geom_smooth(aes(group = plot_type), fill = "NA", size = .8)+
  scale_color_manual(values = c("ddf" = "orange", "evg" = "forestgreen"))+
  theme_minimal() + 
  labs(title = "Seasonal Variation in Canopy Cover by Plot Type",
       x = "Time", y = "Canopy Cover (LAI)", color = "Plot Type")

```
``` {r}
ggplot(data = LAI_plots, aes(x = date, y = LAI_plot, color = plot_id)) +
  geom_point(alpha = .5, size = .3) + 
  geom_line(aes(group = plot_id),size = .1) +
  geom_smooth(aes(group = plot_type), fill = "NA", size = .8)+
  scale_color_manual(values = c("ddf" = "orange", "evg" = "forestgreen"))+
  theme_minimal() + 
  labs(title = "Seasonal Variation in Canopy Cover by Plot Type",
       x = "Time", y = "Canopy Cover (LAI)", color = "Plot Type")

LAI_mean <- LAI %>%
  group_by(plot_id, quad_id) %>%
  summarise(mean_LAI = mean(LAI, na.rm = TRUE))
```


This graph provides an idea of how canopy cover varies among our plots and how LAI varies throughout the dry season. We see evidence of variable phenology between the evergreen and deciduous dominated plot types, expressed by the **evergreen lag in annual minimum LAI** with the deciduous-dominated savanna shedding leaves earlier in the season, plateauing at annual LAI lows in mid-late Feb, while evergreen-dominated forest start shedding leaves later in the season and do not plateau at annual LAI lows until mid-late March. This difference in timing is likely do to phenological trait difference in the evergreen and savanna species. Past studies have shown high degrees of leaf-trait variation within and between deciduous and evergreen species (determining leaf-type can itself be difficult as many "evergreen" species have high magnitudes of deciduousness).

## Part 1: Evaluating the mosaic throughout a dry season: An assessment of fuel availability across a canopy gradient

Canopy cover influences surface fuel in two primary ways: Q1) canopy cover restricts shade-intolerant species, like C4 grasses, reducing the surface fuel load while simultaneously/contrastingly adding to the surface fuel load via leaf shedding, and Q2) canopy cover provides a buffer that moderates microclimate by decreasing daily highs in temp and daily lows in RH (and less significantly by buffering nighttime temp lows and RH highs). As the dry season progresses, microclimate conditions and surface fuel structure change as temperatures reach annual maximums and leaves shed and flush at various intervals according to a diversity of phenologies. Both microclimate and fuel-load are important in establishing the feedbacks that reinforce the mosaic of open-closed canopy states in Cambodia but few empirical records exist (particularly when compared to similar mosaicked ecosystems in Australia, Africa, and South America) that describe the relationship in the region.

**Q1: 1) How does the distribution of surface fuel vary with canopy cover? 2) How does this relationship change throughout the dry season?**

The amount and type of surface fuel is critical to the distribution of forest savanna mosaics (ref). Savannas can be difficult to delineate given the wide range of physiognomies in tree cover that they support, so we define savannas here as an area with continuous grassy understory and a significant tree component (Lehmann et al 2011, Ratnam 2011). This definition is intentionally unconcerned with an upper margin of canopy cover or tree cover or stand height or stand structure because the establishment of rigid physiognomic boundaries (say anything below 60% tree cover is savanna, and anything above is forest) may fail to account for the range of savanna-conforming functional adaptations across different regions with varying climates and evolutionary histories. This may be particular deleterious in regions that do not fit into the current physiognomic description of savanna, but may host a broad lineage of savanna-adapted species and traits. Instead, our definition relies on the ubiquitous relationship between canopy shading and grass exclusion, where at a certain amount of canopy cover, grass is no longer able to grow densely enough to support fire. This is particularly true for the highly flammable C4 grasses, which generally have a lower capacity for establishment in low-light environments (ref).

### 1. 1) The LAI threshold for grass establishment

Past studies suggest that surface fuel composition varies across a gradient of canopy cover, however the precise canopy cover/tree density thresholds for grass exclusion varies by system (Hoffman 2012a, Charles-Dominique 2018). Surface fuels transition from grass to litter as canopy cover increases. Research in forest-savanna mosaics often emphasize the sharpness of the boundaries between open and closed canopy ecosystems. At a given canopy density, grass growth is restricted to such an extent that it is no longer relevant as a fuel source (fire-threshold). In most tropical studies the value of this threshold is \~3.0 LAI (Hoffman 2012a, Cardosa 2018) but no study, to my knowledge, has quantified this relationship, between canopy cover and grass biomass in Southeast Asia (Khaing 2019 looked at the C4 layer and herb layer relationship with Basal Area).

In this analysis, we consider the relationship between LAI and grass load at peak biomass (early in the dry season). We will join the LAI observation 1+2 data with the both early and late season Biomass observations data to assess the relationship. We use observations 1 (Jan. 26) and 2 (Feb. 2) of the LAI data because LAI did not start to decline significantly until LAI ob. 3 (Feb. 8), so averaging obs. 1 and 2 will mitigate deviations in LAI records due to sky conditions at the time of observation without sacrificing data integrity

``` {r grass setup}


```
### 1. 2) Litter distribution across the canopy gradient

Grass burns readily due to its fine, aerated structure and continuity. As a result, grass is the major fuel type that delineates differences in fire recruitment between open and closed ecosystems. But litter is often a critical component of the fuel load depending on the fuel amount and arrangement. In savanna-forest systems, leaf litter tends to increase as tree density increases (Hoffman 2012b, Newberry 2020), and when grass is excluded by canopy density, litter is the primary source of ignition and the primary fuel carrier. I expect litter to increase across the tree density gradient in our system, as in similar studies. However, it is important to note that the savannas in Cambodia are particularly mesic, or more densely treed, than the savannas of similar study systems on other continents (ref), which may result in more litter in the savanna. While in the closed forest, even the most densely canopied tree stands of our research area have a high degree of deciduousness, which may result in more litter in the closed forest.

#### Seasonal Litter Loads

So, we know that canopy cover restricts grass growth, which due to its low bulk density (aerated architecture), is critically important in determining fine scale fire regimes in savanna-forest systems. But, as we established above, grass is not the only relevant component in this fuel matrix. Leaf litter is also a fine, flashy fuel, that can ignite and sustain fire, though typically at much lower rates due to the higher bulk density (compacted architecture) of litter layers. Therefore, evaluating the relationship between woody cover and surface fuel load ought to consider the varying contributions of grass and litter across a gradient of tree cover. As grass load decreases with woody cover, litter loads should increase, replacing the grass proportion of the fine fuel load with litter. These proportions, however, are complicated by many factors from phenology, to composition, to stand age, but especially time of season. In the early dry season, grass biomass is expected to be at its annual maximum, while leaf litter will be close to its annual minimum as few trees have shed their leaves. Thus, the early season fine fuel load, should be particularly grass-heavy. Contrastingly, the late season fine fuel load, should be leaf-heavy after months of litter accumulation.

As canopy density transitions from opened to closed, fuel composition shifts away from being grass dominated and toward being litter dominated. Over the course of a dry season the distinction between open and closed surface fuel loads [decreases]{.underline} as grasses senescence and all deciduous and most evergreen trees (to a lesser magnitude) drop their leaves (Williams 2008), adding to the litter component of the surface fuel composition. The timing of senescence is highly variable among species in seasonal tropical forests, but over the season the result is the ultimately the same: As the dry season progresses, more fuel is added to the surface in the form of litter, packing surface fuels more densely.

This analysis will expand on the idea from analysis 1.1.1, where we looked at fuel load across the canopy gradient, but we will add a factor to the model to evaluate how vegetation load/structure changes from early to late in the dry season.

``` {r litter setup, include = FALSE}
#loading in LAI data
LAI <- read_csv("C:/Users/d/Desktop/UBC 2023/Robinson-Project-MSc/KH_data/LAI/LAI_V1.csv", 
                col_types = cols(date = col_date(format = "%m/%d/%Y"), 
                                 LAI = col_number()))

#make season a factor
LAI$season <- factor(LAI$season)

#make plot_id a factor
LAI$plot_id <- factor(LAI$plot_id)

biomass <- read_csv("C:/Users/d/Desktop/UBC 2023/Robinson-Project-MSc/KH_data/Biomass/biomass_V4.csv", 
                    col_types = cols(grass_height = col_number(), 
                                     litter_depth = col_number(), grass_per = col_number(), 
                                     wood_per = col_number(), bare_per = col_number(), 
                                     litter_per = col_number(), grass_mass = col_number(), 
                                     other_mass = col_number(), wood_mass = col_number(), 
                                     litter_mass = col_number(), seedlings = col_integer()))

#multiply fuel masses by 4 to get g/m2 (quads were .25m l and w)
biomass <- biomass %>%
  mutate(grass_mass = grass_mass*4, litter_mass = litter_mass*4, wood_mass = wood_mass*4, other_mass = other_mass *4)

#make season a factor
biomass$season <- factor(biomass$season)

#make plot_id a factor
biomass$plot_id <- factor(biomass$plot_id)


#we again must average the 3 biomass obs taken at each logger for one observation per logger per seasonal period for a total of 100 (50 x 2) minus 8 equals 92 records.
biomass_seasons <- biomass %>%
  group_by(plot_id, quad_id, season) %>% 
  summarise(grass_mass = mean(grass_mass), litter_mass = mean(litter_mass), 
            wood_mass = mean(wood_mass), other_mass = mean(other_mass), 
            grass_height = mean(grass_height), litter_depth = mean(litter_depth), 
            grass_per = mean(grass_per), litter_per = mean(litter_per))
#isolating and averaging LAI ob 1&2  data across all observations for one value per quadrant (n=50)

LAI_early <- LAI %>%
  group_by(plot_id, quad_id) %>%
  filter(obs_period == "1" | obs_period == "2") %>% 
  summarise(mean_LAI = mean(LAI))

#merging LAI_early and biomass_seasons into LAIxbiomass_seasons
LAI_earlyxbiomass_seasons <- right_join(LAI_early, biomass_seasons, by = c("plot_id", "quad_id"))

#drop the quadrants that did not have biomass records
LAI_earlyxbiomass_seasons <- LAI_earlyxbiomass_seasons %>% drop_na(grass_mass)
```

Currently, we are just evaluating the assumptions of m1, the random intercept model. Rendom slope + intercept seems to fit slightly better, but given that after the interaction with season, each random level of plot_id will only have 4-5 data points. I think that the extra df required for slpoe+intercept is not worth the slight increase in model fit by adding the random slope term. 

```{r litter lmer random int analysis, echo = FALSE}
#Checking out mixed effects models with interaction between mean_LAI and season
#to allow for variable slopes between levels (early and late) of season 

data <- LAI_earlyxbiomass_seasons

#random intercepts model
m1 <- lmer(litter_mass ~ mean_LAI*season + (1|plot_id), data = data, REML = TRUE)
summary(m1)

###Testing Assumptions
sim_residuals <- DHARMa::simulateResiduals(fittedModel = m1)
plotSimulatedResiduals(sim_residuals) # For visual validation of (i)
shapiro_test <- shapiro.test(sim_residuals$scaledResiduals) # For statistical validation of (i)
plotResiduals(sim_residuals) # For visual validation of (iii)
random_effects <- lme4::ranef(m1) # For visual validation of (iv)
plot(random_effects)


### Interpreting coefficients with CIs using emmeans
emtrends(m1, ~ season, var="mean_LAI")

#SO, late season does not include 0 in the 95% CI but early season does, so
#litter load is significant across the LAI gradient in the late but not the early season
```

```{r litter plot, echo = FALSE}
#Now lets graphically represent this
mylist <- list(mean_LAI=seq(0,7,by=1))

#emmip
lit_dat <- emmip(m1,season~mean_LAI, at=mylist , CIs=TRUE, plotit = FALSE)

#make ggplot with emmip data
p <- ggplot(data = lit_dat, aes(x = mean_LAI, y = yvar, color = season)) +
  geom_line() + geom_ribbon(aes(ymax=UCL, ymin=LCL, fill=season), alpha=0.4) +
  labs(title = "Seasonal Variation in Relationship Between Litter Load and Canopy Cover",
       x="LAI", y="Litter Load (g/m2)", color="Season", fill="Season")

#add points from the original data
p + geom_point(data = data, aes(x = mean_LAI, y = litter_mass, color = season), alpha = .5) 

```


### 1. 3) Fine Fuel Load (Litter + Grass) across the dry season

"Along with litter, grasses represent the most important combustible material in most tropical ecosystems, especially in the savannas and the tropical grasslands (Stott 2000)"

Dry grass and dry leaf litter are the main components of fine dead fuel. However, in the field, grass and litter tend to have contrasting flammability, largely due to variation in fuel arrangement, specifically bulk density (g/m). The compact arrangement - high bulk density - of litter reduces fire likelihood and spread compared to the light, aerated architecture - low bulk density - of grass. Curing grasses invite a passing fuel source to ignite and carry fire more readily. In savanna-forest mosaics of other continents, bulk density has been identified as the primary driver in establishing the functional dichotomy between forest and savanna (Hoffman 2012b, Newberry 2020). I anticipate fine fuel bulk densities to increase as grass biomass decreases and litter biomass increases. I predict peak bulk densities will correspond to peak canopy cover, where litter accumulation should be greatest and grass presence should be lowest.

The densely treed savannas of Northern Cambodia may require extra consideration of the litter component of their surface fuel makeup, when considering their potential fire effects. In less treed savannas, grass connectivity is sometimes considered in isolation - as then sole source of surface fuel. To ignore litter at Khun Ream would be to ignore half of the fine fuel makeup, and to ignore the seasonal dynamics of surface fuel.

We will look at the total fine fuel loads (grass + litter) in the early and late season to better understand how the fuel load shifts from grass dominated to litter dominated.

```{r fine fuel setup}

LAI_earlyxbiomass_seasons <- LAI_earlyxbiomass_seasons %>% 
  mutate(fine_mass = grass_mass + litter_mass)

LAI_earlyxbiomass_seasons <- LAI_earlyxbiomass_seasons %>% 
  mutate(fuel_load = grass_mass + litter_mass + wood_mass + other_mass)

#remove huge bamboo outlier 
data <- LAI_earlyxbiomass_seasons

z_scores <- scale(data$grass_mass)
outliers <- abs(z_scores) > 3  # Adjust the threshold as needed

# Create a subset without outliers
data <- data[!outliers, ]

```

``` {r fine fuel model}
m1 <- lmer(fine_mass ~ mean_LAI*season + (mean_LAI^2) *season + (1|plot_id), data = data, REML = TRUE)
summary(m1)

plot(m1)

###Testing Assumptions
sim_residuals <- DHARMa::simulateResiduals(fittedModel = m1)
plotSimulatedResiduals(sim_residuals) # For visual validation of (i)
shapiro_test <- shapiro.test(sim_residuals$scaledResiduals) # For statistical validation of (i)
plotResiduals(sim_residuals) # For visual validation of (iii)
random_effects <- lme4::ranef(m1) # For visual validation of (iv)
plot(random_effects)

```

``` {r fine fuel plot}
ggplot(data = data, aes(x=mean_LAI, y = fine_mass, color = season)) +
  geom_point() + stat_smooth(method = "lm", formula = y ~ poly(x, 2))

```
The key here is that between the early and late season there is a dramatic shift from a grass dominated to litter dominated fine fuel loads in the open canopy. There is a large litter component in our system compared to savanna-forest mosaics elsewhere. In both the savanna and the forest, we see ~doubling of litter loads that, when paired with decreasing grass loads, result in similar fine fuel loads across the canopy gradient (in the late season) compared to the declining fine fuel loads in the early season where grasses are at annual maximums and most litter has yet to fall. The consequences on fire likelihood from this seasonal change in fine fuel composition will be discussed in the following modeling chapter. 


###1. 4) Fuel Bulk Density

```{r 1.2.4 bulk density setup}

data <- data %>%
  mutate(bulk_density = ifelse(grass_mass > 20, (grass_mass+litter_mass+wood_mass+other_mass)/ (grass_height/100), (grass_mass+ litter_mass + wood_mass + other_mass)/ (litter_depth/100)))

bulk_avg <- data  %>% 
  group_by(plot_id, quad_id) %>% 
  summarize(bulk_density = mean(bulk_density), mean_LAI = mean(mean_LAI))
  
```

```{r bulk density model}

m1 <- lmer(bulk_density ~ mean_LAI + (mean_LAI^2)+ (1|plot_id) , data = data)
summary(m1)

plot(m1)

###Testing Assumptions
sim_residuals <- DHARMa::simulateResiduals(fittedModel = m1)
plotSimulatedResiduals(sim_residuals) # For visual validation of (i)
shapiro_test <- shapiro.test(sim_residuals$scaledResiduals) # For statistical validation of (i)
plotResiduals(sim_residuals) # For visual validation of (iii)
random_effects <- lme4::ranef(m1) # For visual validation of (iv)
plot(random_effects)

```
These assumptions don't look great but their the best I've got at the moment. I ended up using a quadratic that fits the data pretty well and maybe barely passes assumptions, but the intercept is quite high because almost all of the DDF points fall at ~0.

Here is the plot with the quadratic fit:

```{r 1.2.4a plot}
ggplot(data, aes(x = mean_LAI, y = bulk_density/1000))+
  geom_point(aes(color = plot_id)) +
  stat_smooth(method = "lm", fill =  formula = y ~ poly(x, 2)) +
  labs(title = "Seasonal Bulk Density Across the Tree Cover Gradient",
       x = "LAI", y = "Fine Fuel Bulk Density (g/m3)", color = "Season") +
  theme_minimal() 

``` 





**Q2: 1) How does surface microclimate vary with canopy cover? 2) How does this relationship change throughout the dry season?**

In Q1 we looked at how fuel is distributed along the canopy gradient, in that question we were essentially looking at fuel availability in terms of the physical presence of flammable vegetation. At the coarsest scale, fuel presence is determined by climate (Meyn 2007). In our system, the precipitation is sufficient to support continuous vegetation and the presence of fuel is largely moderated through site-specific edaphic conditions and fire-feedbacks (Pausas, ref..) ( see outline). Once present or absent, fuel amount tends to change due to relatively slow process (growth and decay), unless it is removed by a consumer (fire, grazer, or otherwise). In the absence of cow or fire, surface fuels will accumulate gradually with leaf fall (dry season) or new herbaceous growth (wet season) or decrease gradually through dessication.

Contrastingly, weather can affect surface fuel on a finer temporal scale (ref). Weather affects fuel availability through daily fluctuations in temperature and RH, so that fuel that is not available to burn at 0900, may be quite flammable at 1700. However, weather also acts on coarser scales, and it may take weeks or months of drought to dry fuels sufficiently to sustain fire, particularly in moist (high RH) and mesic-dense canopied systems. Atmospheric moisture is absorbed by fuels, particularly dead fuels, and tree canopies buffer surface fuel conditions by moderating microclimates under the canopy. Wet fuel is not available to fire, no matter how much fuel there is. So after they are saturated, fuels must dry sufficiently before they can be available to fire. The threshold fuel moisture at which combustion can be sustained is referred to as the **moisture of extinction.** The moisture of extinction is dependent on fuel composition, fuel amount, and fuel structure (ref), therefore, it is variable throughout the season as the orientation of fuels changes (as described in Q1) (ref. I know this is explicitly stated but i cant find it). The time it takes for a fuel parcel to cross the moisture of extinction and become dry enough for combustion is dependent on several interacting factors ( need to elaborate on this, perhaps, see the fuel moisture section in annotated bib ), most relevant of which is **microclimate buffering** (ref). Fuels that are under a dense canopy take longer to dry (longer to cross the moisture of extinction) than fuels that are in the open exposed to direct sunlight. Therefore, if we take two identical fuels, one shaded and one unshaded, the unshaded fuel will be able to ignite, or "available" to fire quicker than the shaded fuel. This is really fundamental stuff, but I find that breaking the fire process down to its most basic principals helps in understanding the different roles of fuel structure and fuel microclimate. In Q2, we are concerned with this more mercurial side of fuel availability: the components of fuel availability that are determined by **microclimate.**

Tree canopies moderate microclimate by acting as a thermal insulator, buffering surface fuels from atmospheric extremes (Frenne 2019). In a Dipterocarp fire regime, a closed canopy will restrict light availability at the forest floor resulting in wetter midday fuels and lower relative fuel availability. In contrast, the microclimates of open systems promote flammability at the surface as radiation passes through gaps in the canopy, drying surface fuels with the rising of the sun each day.

### 2. 1) Microclimate TOMST (surface temp) varies across canopy cover

Past research suggests that relationships between canopy cover and microclimate buffering tend to be linear in tropical forest systems (Hardwick 2015). But the extent of buffering, or the slope of microclimate buffering across the canopy gradient should increase as open-air (macroclimate) temperatures increase. Basically, as macroclimate heat or open-air heat temperatures get more extreme, open canopies should be relatively worse bufferers and closed canopies should be relatively better bufferers, exaggerating the differences in microclimate between open and closed systems (Davis 2018, De Frenne 2019).

In this analysis we will be looking at the relationship between surface microclimate and canopy cover across the season to better understand the role of microclimate trends in determining fuel availability from the Jan to April. 


### 2. 2) Microclimate Kestrel (RH, Wind, Temp) varies by LAI across the season

**Wind Speed**
This is just for illustrative purposes to go with the behaveplus plots to visual explain the difference in wind speed.
``` {r wind setup}
#daily max windspeed
kestrel_V1 <- read_csv("C:/Users/d/Desktop/UBC 2023/Robinson-Project-MSc/KH_data/Kestrel/kestrel_V1.csv", 
     col_types = cols(month = col_integer(), 
         day = col_integer(), temp = col_number(), 
         rh = col_number(), wind_speed = col_number()))

kestrel_wind <- kestrel_V1 %>% 
  group_by(month, day, plot_id) %>% 
  summarize(wind_speed = max(wind_speed))

library(lubridate)

kestrel_wind <- kestrel_wind %>% 
  mutate(year = "2024")

kestrel_wind <- kestrel_wind %>% 
  mutate(date = dmy(paste(day, month, year, sep = "/")))
```

```{r wind plot)}
#identify LAI ranges for each kestrel: 
LAI %>% 
  group_by(plot_id, quad_id)%>% 
  summarize(range = range(LAI, na.rm = TRUE))

evg3 <- LAI %>% 
  filter(plot_id == "evg3")

ggplot(kestrel_wind, aes(x = date, y = wind_speed, color = plot_id)) +
  geom_point(size = .7, alpha = .7) + geom_line(alpha = .5) +
  labs(title = "Daily Wind Speed at Varying LAI Across Dry Season",
       x = "Date", y = "Wind Speed (m/s)", color = "LAI Range") +
  scale_color_manual(labels = c("1.0-2.2", "1.1-2.0", "0.4-1.0", "4.0-5.4", "3.6-7.2", "5.0-6.9"), values = c("red", "gold", "darkorange", "blue", "purple", "maroon"))+
  theme_minimal() 
  
```

**Relative Humidity (RH%)**
```{r RH setup}

```

```{r RH plot}

```

### 2. 3) Fuel Moisture Content


### 3. 1) Behaveplus6 Fire Modelling Setup (Lengthy, Jump t0 next section, "Behave Output" for the modelled fire results)

A major focus of this research is fuel availability, with particular attention placed on the variability of surface fuels between open and closed canopy ecosystems and the variability in surface fuels over the dry season. Fuel is available to fire when fuel moisture is sufficiently low and when fuel composition is distributed in a continuous arrangement conducive to fire spread. The interplay of these variables in determining fuel availability creates a heterogenous distribution of flammability throughout the horizontal and vertical composition of the environment. In Southeast Asia, fires occur every year, but the location, size, and intensity of fires is determined as a product of these concurrent factors.

**The plots are aligned with these models:**

-   TL6/186 - Moderate load, less compact. Spread rate moderate; flame length low. PRIMARY CARRIER OF THE FIRE IS DEAD AND DOWN WOODY FUEL (LITTER) BENEATH A FOREST CANOPY. Mositure of extinction is 25 percent: **DDF2, EVG1, EVG2, EVG3, EVG4, EVG5**

-   TU3/163 - Fuel bed is moderate litter load with grass and shrub components. Humid climate. Spread rate high; flame length moderate. PRIMARY CARRIER OF THE FIRE IS GRASS OR SHRUBS MIXED WITH LITTER FROM FOREST CANOPY (TIMBER-UNDERSTORY). Extinction moisture is 30 percent: **DDF3**

-   GR5/105 - Dense, coarse grass, average depth about 1 to 2 feet (0.3 to 0.6 meters). Spread rate very high; flame length high. Subhumid to humid climate (rainfall adequate in all seasons). Extinction moisture content 40 percent. Spread rate high; flame length moderate.PRIMARY CARRIER GRASS: **DDF4, DDF5, DDF6**


Since I messed up the early season fuel moisture by not collecting litter, for the cross season analysis I will use the first viable fuel moisture observations, which are from observation 4 (Feb 16), which is 2-3 weeks after the January biomass sampling, but still before the big LAI and temperature dip. Its not perfect, but will still allow me to compare fuels that are 6 weeks apart.

I'm still going to average LAI around the obs to account for any missing values or bad recordings. And since early season biomass is in late Jan and the fuel moisture is in mid Feb, including the LAI in the range of those two feels like a good move.

```{r behave3.2 LAI, include = FALSE}
#loading in LAI data
LAI <- read_csv("C:/Users/d/Desktop/UBC 2023/Robinson-Project-MSc/KH_data/LAI/LAI_V1.csv", 
    col_types = cols(date = col_date(format = "%m/%d/%Y"), 
        obs_period = col_integer(), LAI = col_double(), 
        month = col_integer()))

#pulling LAI data from early ob: 2-4  and late ob: 6-8
LAI_3.2_early <- LAI %>% 
  filter(obs_period %in% c(2,3,4)) %>% 
  group_by(plot_id, quad_id, season) %>% 
  summarize(mean_LAI = mean(LAI, na.rm = TRUE))

LAI_3.2_late <- LAI %>% 
  filter(obs_period %in% c(6,7,8)) %>% 
  group_by(plot_id, quad_id, season) %>% 
  summarize(mean_LAI = mean(LAI, na.rm = TRUE))

#stack the tables for early and late together
LAI_3.2<- dplyr::union(LAI_3.2_early, LAI_3.2_late)
```

Fuel moisture is not averaged, but taken from the closest viable single obs to the biomass obs.

```{r behave3.2 fuel_mositure, include = FALSE}
fm_V5 <- read_csv("C:/Users/d/Desktop/UBC 2023/Robinson-Project-MSc/KH_data/Fuel-Moisture/fm_V5.csv", 
    col_types = cols(date = col_date(format = "%m/%d/%Y"), grass = col_number(), woody_leaf = col_number(),litter = col_number(), hundred_hr = col_number(), ten_hr = col_number(), one_hr = col_number()))

#Averaging fm for each fuel class for obs period 4 and 7
fm_3.2 <- fm_V5 %>% 
  filter(obs_period %in% c(4,7)) %>% 
 group_by(plot_id, quad_id, obs_period) %>%
  summarise(woody_leaf = mean(woody_leaf, na.rm = TRUE), grass = mean(grass, na.rm = TRUE), litter = mean(litter, na.rm = TRUE), ten_hr = mean(ten_hr, na.rm = TRUE), hundred_hr = mean(hundred_hr, na.rm = TRUE))

fm_3.2 <- fm_3.2 %>% 
  mutate(season = case_when(
    obs_period == 4 ~ "early",
    obs_period == 7 ~ "late"
  ))
```

Biomass observations separated by early and late season.

```{r behave3.2 biomass, include = FALSE}
biomass <- read_csv("C:/Users/d/Desktop/UBC 2023/Robinson-Project-MSc/KH_data/Biomass/biomass_V2.csv", 
     col_types = cols(grass_height = col_number(), litter_depth = col_number(), grass_per = col_number(), wood_per = col_number(), bare_per = col_number(),  litter_per = col_number(), mass_grass = col_number(), mass_liana = col_number(), mass_wood = col_number(), mass_litter = col_number(), seedlings = col_number(), grass_vol = col_number(), grass_bulk = col_number(), litter_vol = col_number(), litter_bulk = col_number(), fine_vol = col_number(), fine_bulk = col_number()))

#there were two biomass observation periods in early and late season and each quadrant consisted of 3 records for a total of n=150 records for each season and n=300 records in total
#we will average across quadrants and keep season separate for n=100 records (8 of which are NA because no data for the missing sensors)

biomass_3.2 <- biomass %>%
  group_by(plot_id, quad_id, season) %>%
  summarise(grass_mass = mean(mass_grass), litter_mass = mean(mass_litter), wood_mass = mean(mass_wood), woody_mass = mean(mass_liana + seedlings*10), grass_height = mean(grass_height), litter_depth = mean(litter_depth))

#the biomass input in the model requires mass per unit area so we will determine kg/m^2 for each fuel type. The quadrat was .25m^2.

biomass_3.2 <- biomass_3.2 %>% 
  group_by(plot_id) %>% 
  mutate_at(vars(4:7), ~ . * .004)
```

Using the exact same shading from 3.1 (this is an average across the whole season, but honestly I'm afraid to change it because this measurement was too subjective and my early season measurements and Phem's late season measurements may not jive)

```{r behave 3.2 shading, include = FALSE}
shaded <- biomass %>% 
  group_by(quad_id, plot_id) %>% 
  filter(shading == 'Y') %>%
  count()

unshaded <- biomass %>% 
  group_by(quad_id, plot_id) %>% 
  filter(shading == 'N') %>% 
  count()

shade_join <- left_join(shaded, unshaded, by=c("plot_id", "quad_id"))

shade_pct <- shade_join %>% 
  transmute(shade = n.x/(n.x + n.y)) 

shade_pct$shade <- shade_pct$shade %>% 
  replace_na(1)

shade_pct <- shade_pct %>% 
  summarise(shade = shade*100)
```

Re-did this convoluted wind estimation for early and late season, notes detailed in the code.

```{r behave 3.2 wind, message=FALSE, warning=FALSE, include=FALSE}
kestrel_V1 <- read_csv("C:/Users/d/Desktop/UBC 2023/Robinson-Project-MSc/KH_data/Kestrel/kestrel_V1.csv", 
    col_types = cols(temp = col_number(), 
        rh = col_number(), wind_speed = col_number()))

kestrel_wind <- kestrel_V1 %>% 
  group_by(month, day, plot_id) %>% 
  summarize(wind_speed = max(wind_speed))

kestrel_wind <- kestrel_wind %>% 
  mutate(season = case_when(
    month %in% c("1","2") ~ 'early',
    month %in% c("3","4") ~ 'late'
  ))

#summary table for wind speed by plot (n=6)
kestrel_wind %>% 
  group_by(plot_id, season) %>% 
  summarize(wind_speed = mean(wind_speed))

LAI_3.2 %>% 
  group_by(plot_id, season) %>% 
  summarize(LAI = mean(mean_LAI))

#creating model for wind speed from relationship with LAI to fill in values for 4 missing plots
#made quick table relating LAI and wind_speed values from above
windxLAI_3.2 <- read_csv("C:/Users/d/Desktop/UBC 2023/Robinson-Project-MSc/KH_data/Kestrel/windxLAI_3.2.csv", 
    col_types = cols(LAI = col_number(), 
   wind_speed = col_number()))


lm <- lm(wind_speed ~ LAI, data = windxLAI_3.2)
summary(lm)

ggplot(windxLAI_3.2, aes(x = LAI, y = wind_speed)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  labs(x = "LAI", y = "Wind Speed") +
  ggtitle("Wind Speed vs LAI regression")

#using lm to predict windspeeds for 4 no-kestrel plots
missing_rows <- is.na(windxLAI_3.2$wind_speed)
new_data <- windxLAI_3.2[missing_rows, ]
new_data$wind_speed <- predict(lm,newdata= new_data)
windxLAI_3.2[missing_rows, ] <- new_data

```

Temperature taken from the same day as fuel moisture, as fuel moisture is the variable most linked to microclimate (and the most mercurial/prone to daily flux).

```{r behave 3.2 TOMST temperature, include = FALSE}
TOMST_V1 <- read_csv("C:/Users/d/Desktop/UBC 2023/Robinson-Project-MSc/KH_data/TOMST/TOMST_V1.csv", 
    col_types = cols(date = col_date(format = "%Y.%m.%d"), 
        date_time = col_datetime(format = "%Y.%m.%d %H:%M"), 
        air_temp = col_number(), soil_moisture = col_number()))

#average air_temp values for each quadrant for the days that match the fuel moisture
#first filter data between midday times
TOMST_filter <- TOMST_V1 %>% 
filter(hour(date_time) > 10, hour(date_time) < 18) 

TOMST_3.2 <- TOMST_filter %>% 
  filter(date %in% c("2023-02-16", "2023-03-29", "2023-03-30"))

TOMST_3.2 <- TOMST_3.2 %>%
  mutate(season = case_when(
    date %in% c('2023-02-16') ~ 'early',
    date %in% c('2023-03-29', '2023-03-30') ~ 'late'
  ))

TOMST_3.2 <- TOMST_3.2 %>% 
group_by(plot_id, quad_id, season) %>% 
  summarize(air_temp = mean(air_temp), soil_moist = mean(soil_moisture))
  
```

Lastly, we will populate the input for surface area to volume ratio (SA:V) and moisture of extinction for each plot by identifying which of the 40 standard fuel models (Scott and Burgan 2005) best fit our field observations.

```{r fuel models, include=FALSE}
#we will find the average fuel load and fuel depth per plot and convert to tonnes/acre (1 to 10) to help gauge which of Scott and Burgan's 40 models is the best fuel model to pair each plot with.

biomass_load %>%
  group_by(plot_id) %>%
  summarise(across(everything(), mean, na.rm = TRUE)) %>% 
  mutate_at(vars(3:6), ~ . * 10)

```


**The plots are aligned with these models:**

-   TL6/186 - Moderate load, less compact. Spread rate moderate; flame length low. PRIMARY CARRIER OF THE FIRE IS DEAD AND DOWN WOODY FUEL (LITTER) BENEATH A FOREST CANOPY. Mositure of extinction is 25 percent: **DDF2, EVG1, EVG2, EVG3, EVG4, EVG5**

-   TU3/163 - Fuel bed is moderate litter load with grass and shrub components. Humid climate. Spread rate high; flame length moderate. PRIMARY CARRIER OF THE FIRE IS GRASS OR SHRUBS MIXED WITH LITTER FROM FOREST CANOPY (TIMBER-UNDERSTORY). Extinction moisture is 30 percent: **DDF3**

-   GR5/105 - Dense, coarse grass, average depth about 1 to 2 feet (0.3 to 0.6 meters). Spread rate very high; flame length high. Subhumid to humid climate (rainfall adequate in all seasons). Extinction moisture content 40 percent. Spread rate high; flame length moderate.PRIMARY CARRIER GRASS: **DDF4, DDF5, DDF6**


**Making the Behave table**

Merging all of the above data into one table for behave plus input
Setup same as 3.1. Table written to data folder.

```{r behave3.2 table setup, inlcude = FALSE}
#merging all of the relevant input variables, detailed below:
join1 <- left_join(LAI_3.2, biomass_3.2, by=c("plot_id", "quad_id", "season"))

join2 <- left_join(join1, fm_3.2, by=c("plot_id", "quad_id", "season"))

join3 <- left_join(join2, windxLAI_3.2, by= c("plot_id", "season"))

join4 <- left_join(join3, shade_pct, by=c("plot_id", "quad_id"))

behave_tbl_3.2 <- left_join(join4, TOMST_3.2, by=c("plot_id", "quad_id", "season"))

```

**Breakdown of input values (SURFACE fire spread model and Probability of Ignition (PIG) model):**

-   Fuel Model Number

-   Fuel Model Code: Plot fuel characteristics compared with Burgan's 40 fuel models to determine best fit.

-   1-hr fuel load (kg/m2): Input from litter load

-   10-hr fuel load (kg/m2): Input from half of wood load

-   100-hr fuel load (kg/m2): Input from half of wood load

-   Live Herbaceous Fuel Load (kg/m2): Input from grass load

-   Live Woody Fuel Load (kg/m2): Input from woody load

-   1-h, Live Herbaceous, and Live Woody SA/V (m2/m3): Input from model constants for each plot (see above step)

-   Fuel Bed Depth (m): Input from grass height when grass is relatively continuous enough to sustain fire (>0.1kg/m2), otherwise determined from litter depth

-   Dead fuel moisture of extinction (%): Similar to SA/V, auto-populated by fuel code

-   Dead Fuel and Live Fuel Heat Content (kJ/kg): Held constant = 18622

-   Fuel Moisture (%): All fuel moisture input come from fuel moisture averages described above

-   Midflame Windspeed: Max daily kestrel values averaged over season

-   Slope Steepness (%): Held constant at 0, very little slope involved in area

-   Temperature (C): Input from TOMST values averaged between 10:00 and 18:00 for all quadrants

-   Fuel Shading From Sun (%): Values determined from biomass data of visual estimations of canopy cover as Bernoulli distributed (they just yes or no), and then averaged for each quadrant

**Output**

-   Surface Fire Rate of Spread (ROS) (m/min):

-   Surface Fireline Intensity (kW/m):

-   Surface Fire Flame Length (m):

-   Probability of Ignition (PIG) (%):


#### Behave Output: Final Table of fuel variables and behave outputs

```{r behave3.2 output table, include = FALSE}
behave_output3.2 <- read_csv("C:/Users/d/Desktop/UBC 2023/Robinson-Project-MSc/KH_data/Behaveplus/behave_3.2_V2.csv", 
    col_types = cols(mean_LAI = col_number(), 
        fuel_model = col_integer(), litter_load = col_number(), 
        hr10_load = col_number(), hr100_load = col_number(), 
        herb_load = col_number(), woody_load = col_number(), 
        grass_height = col_number(), litter_depth = col_number(), 
        litter_fm = col_number(), hr10_fm = col_number(), 
        hr100_fm = col_number(), grass_fm = col_number(), 
        woody_fm = col_number(), wind_speed = col_number(), 
        air_temp = col_number(), shade = col_number(), 
        soil_moist = col_number(), ROS = col_number(), 
        intensity = col_number(), flame_length = col_number(), 
        PIG = col_integer()))
```


```{r 3.2 ROS data analysis}

gam_model <- gam(ROS ~ season + s(mean_LAI, by = season, k=5),
                         data = behave_output3.2, method = "REML")


summary(gam_model)
k.check(gam_model)
gam.check(gam_model)

#Trying a different distribution

gam_model_tw <- gam(ROS ~ season + s(mean_LAI, by = season, k=5),
                    family = tw(link = "log"), data = behave_output3.2, method = "REML")
  
summary(gam_model_tw)
k.check(gam_model_tw)
gam.check(gam_model_tw)

#They look much better with a tweedie dist

```


d

